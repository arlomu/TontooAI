<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Tontoo AI | Admin</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="main-layout">
        <div class="sidebar">
            <div class="sidebar-header" style="text-align: center; margin-bottom: 30px; color: var(--text-farbe);">
                <img src="icon.png" alt="AI Icon" width="64" height="64">
                <h2 id="adminPanelTitle"></h2>
            </div>
            <nav>
                <div class="admin-nav-item active" data-section="dashboard">
                    <i class="fas fa-chart-line"></i> <span id="dashboardNav"></span>
                </div>
                <div class="admin-nav-item" data-section="users">
                    <i class="fas fa-users"></i> <span id="usersNav"></span>
                </div>
                <div class="admin-nav-item" data-section="models">
                    <i class="fas fa-brain"></i> <span id="modelsNav"></span>
                </div>
                <div class="admin-nav-item" data-section="integrations"> <!-- NEU: Integrations-Nav-Item -->
                    <i class="fas fa-puzzle-piece"></i> <span id="integrationsNav"></span>
                </div>
                <div class="admin-nav-item" data-section="config">
                    <i class="fas fa-cog"></i> <span id="configNav"></span>
                </div>
                <div class="admin-nav-item" data-section="ollama">
                    <i class="fas fa-server"></i> <span id="ollamaNav"></span>
                </div>
            </nav>
        </div>

        <div class="content-area">
            <div class="admin-content">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="admin-section active">
                    <h2 id="dashboardTitle"></h2>
                    <div class="dashboard-stats" style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div class="stat-card">
                            <h3 id="tokenTodayTitle"></h3>
                            <p id="tokensToday"></p>
                        </div>
                        <div class="stat-card">
                            <h3 id="tokenTotalTitle"></h3>
                            <p id="tokensOverall"></p>
                        </div>
                        <div class="stat-card">
                            <h3 id="cpuUsageTitle"></h3>
                            <p id="cpuUsage"></p>
                        </div>
                        <div class="stat-card">
                            <h3 id="ramUsageTitle"></h3>
                            <p id="ramUsage"></p>
                        </div>
                    </div>
                </div>

                <!-- Users Section -->
                <div id="users-section" class="admin-section">
                    <div class="section-header">
                        <h2 id="usersTitle"></h2>
                        <button id="addUserBtn"><i class="fas fa-plus"></i> <span id="addUserBtnText"></span></button>
                    </div>
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th id="usernameTh"></th>
                                <th id="emailTh"></th>
                                <th id="nameTh"></th>
                                <th id="maxTokensTh"></th>
                                <th id="usedTokensTh"></th>
                                <th id="adminTh"></th>
                                <th id="actionsTh"></th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                        </tbody>
                    </table>
                </div>

                <!-- Models Section -->
                <div id="models-section" class="admin-section">
                    <div class="section-header">
                        <h2 id="modelsTitle"></h2>
                        <button id="addModelBtn"><i class="fas fa-plus"></i> <span id="addModelBtnText"></span></button>
                    </div>
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th id="modelIdTh"></th>
                                <th id="displayNameTh"></th>
                                <th id="actionsModelTh"></th>
                            </tr>
                        </thead>
                        <tbody id="modelTableBody">
                        </tbody>
                    </table>
                </div>

                <!-- NEU: Integrations Section -->
                <div id="integrations-section" class="admin-section">
                    <div class="section-header">
                        <h2 id="integrationsTitle"></h2>
                        <form id="integrationUploadForm" enctype="multipart/form-data" style="display: flex; gap: 10px; align-items: center;">
                            <input type="file" id="integrationFile" name="integrationZip" accept=".zip" required style="display: none;">
                            <label for="integrationFile" class="button"><i class="fas fa-upload"></i> <span id="uploadIntegrationBtnText"></span></label>
                            <button type="submit" style="display: none;"></button> <!-- Hidden submit button -->
                            <span id="selectedFileName" style="color: var(--sekundaer-text-farbe); font-size: 0.9em;"></span>
                        </form>
                    </div>
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th id="integrationNameTh"></th>
                                <th id="integrationDescriptionTh"></th>
                                <th id="integrationAuthorTh"></th>
                                <th id="integrationVersionTh"></th>
                                <th id="integrationLicenseTh"></th>
                                <th id="actionsIntegrationTh"></th>
                            </tr>
                        </thead>
                        <tbody id="integrationTableBody">
                        </tbody>
                    </table>
                </div>

                <!-- Config Section -->
                <div id="config-section" class="admin-section">
                    <div class="section-header">
                        <h2 id="configTitle"></h2>
                        <button id="saveConfigBtn"><i class="fas fa-save"></i> <span id="saveConfigBtnText"></span></button>
                    </div>
                    <div id="configForm">
                        <div class="config-group">
                            <h3><i class="fas fa-network-wired"></i> <span id="serverSettingsTitle"></span></h3>
                            <div class="form-group">
                                <label for="mainPort" id="mainPortLabel"></label>
                                <input type="number" id="mainPort" name="main-port">
                            </div>
                            <div class="form-group">
                                <label for="sslPort" id="sslPortLabel"></label>
                                <input type="number" id="sslPort" name="ssl-port">
                            </div>
                            <div class="form-group">
                                <label for="hostName" id="hostNameLabel"></label>
                                <input type="text" id="hostName" name="host">
                            </div>
                            <div class="form-group">
                                <label for="trustedDomains" id="trustedDomainsLabel"></label>
                                <input type="text" id="trustedDomains" name="trusted-domains">
                            </div>
                        </div>

                        <div class="config-group">
                            <h3><i class="fas fa-robot"></i> <span id="ollamaSettingsTitle"></span></h3>
                            <div class="form-group">
                                <label for="ollamaPort" id="ollamaPortLabel"></label>
                                <input type="number" id="ollamaPort" name="ollama-port">
                            </div>
                            <div class="form-group">
                                <label for="ollamaHost1" id="ollamaHost1Label"></label>
                                <input type="text" id="ollamaHost1" name="ollama-host1">
                            </div>
                            <div class="form-group">
                                <label for="ollamaHost2" id="ollamaHost2Label"></label>
                                <input type="text" id="ollamaHost2" name="ollama-host2">
                            </div>
                        </div>

                        <div class="config-group">
                            <h3><i class="fas fa-envelope"></i> <span id="emailSettingsTitle"></span></h3>
                            <div class="form-group admin-checkbox">
                                <label for="smtpEnabled" id="smtpEnabledLabel"></label>
                                <input type="checkbox" id="smtpEnabled" name="smtp-enabled">
                            </div>
                            <div class="form-group">
                                <label for="smtpHost" id="smtpHostLabel"></label>
                                <input type="text" id="smtpHost" name="smtp-host">
                            </div>
                            <div class="form-group">
                                <label for="smtpPort" id="smtpPortLabel"></label>
                                <input type="number" id="smtpPort" name="smtp-port">
                            </div>
                            <div class="form-group admin-checkbox">
                                <label for="smtpSecure" id="smtpSecureLabel"></label>
                                <input type="checkbox" id="smtpSecure" name="smtp-secure">
                            </div>
                            <div class="form-group">
                                <label for="smtpUser" id="smtpUserLabel"></label>
                                <input type="text" id="smtpUser" name="smtp-user">
                            </div>
                            <div class="form-group">
                                <label for="smtpPass" id="smtpPassLabel"></label>
                                <input type="password" id="smtpPass" name="smtp-pass">
                            </div>
                        </div>

                        <div class="config-group">
                            <h3><i class="fas fa-language"></i> <span id="aiSettingsTitle"></span></h3>
                            <div class="form-group">
                                <label for="configLanguage" id="configLanguageLabel"></label>
                                <input type="text" id="configLanguage" name="sprache">
                            </div>
                            <div class="form-group">
                                <label for="systemPrompt" id="systemPromptLabel"></label>
                                <textarea id="systemPrompt" name="system-prompt" rows="6"></textarea>
                            </div>
                        </div>

                        <div class="config-group">
                            <h3><i class="fas fa-shield-alt"></i> <span id="aiProtectionTitle"></span></h3>
                            <div class="form-group admin-checkbox">
                                <label for="messageGuardEnabled" id="messageGuardEnabledLabel"></label>
                                <input type="checkbox" id="messageGuardEnabled" name="message-guard-enabled">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ollama Management Section -->
                <div id="ollama-section" class="admin-section">
                    <div class="section-header">
                        <h2 id="ollamaTitle"></h2>
                        <div>
                            <button id="pullModelBtn"><i class="fas fa-download"></i> <span id="downloadModelBtnText"></span></button>
                            <button id="removeModelBtn" class="danger"><i class="fas fa-trash"></i> <span id="removeModelBtnText"></span></button>
                        </div>
                    </div>
                    <div class="ollama-status">
                        <h3 id="serverStatusTitle"></h3>
                        <div id="ollamaServerStatus" style="display: flex; gap: 20px; margin: 20px 0;">
                            <div class="status-card">
                                <h4>Host 1 (<span id="host1Name"></span>)</h4>
                                <p id="host1Status"></p>
                            </div>
                            <div class="status-card">
                                <h4>Host 2 (<span id="host2Name"></span>)</h4>
                                <p id="host2Status"></p>
                            </div>
                        </div>
                    </div>
                    <div id="ollamaResults" style="margin-top: 20px;"></div>
                </div>
            </div>

            <div class="user-info-footer" id="userInfoFooter">
                <i class="fas fa-user icon"></i>
                <span id="userTokensSummary"></span>
                <div class="user-info-popup" id="userInfoPopup">
                    <p>⚡ <span id="usedTokensLabel"></span>: <span id="popupUsedTokens"></span></p>
                    <p>⚡ <span id="maxTokensLabel"></span>: <span id="popupMaxTokens"></span></p>
                    <button onclick="window.location.href='/settings.html'"><i class="fas fa-cog"></i> <span id="settingsBtnText"></span></button>
                    <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> <span id="logoutBtnText"></span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-button">&times;</button>
            <h3 id="userModalTitle"></h3>
            <form id="userForm">
                <input type="hidden" id="userId" name="id">
                <div class="form-group"><label for="modalUsername" id="modalUsernameLabel"></label><input type="text" id="modalUsername" name="username" required></div>
                <div class="form-group"><label for="modalEmail" id="modalEmailLabel"></label><input type="email" id="modalEmail" name="email" required></div>
                <div class="form-group"><label for="modalPassword" id="modalPasswordLabel"></label><input type="password" id="modalPassword" name="password"></div>
                <div class="form-group"><label for="modalFirstName" id="modalFirstNameLabel"></label><input type="text" id="modalFirstName" name="firstName" required></div>
                <div class="form-group"><label for="modalMaxTokens" id="modalMaxTokensLabel"></label><input type="text" id="modalMaxTokens" name="max-tokens" value="--"></div>
                <div class="form-group admin-checkbox"><label for="modalAdmin" id="modalAdminLabel"></label><input type="checkbox" id="modalAdmin" name="admin"></div>
                <div class="form-group"><label for="modalPersonalPrompt" id="modalPersonalPromptLabel"></label><textarea id="modalPersonalPrompt" name="personal-ai-prompt" rows="3"></textarea></div>
                <div class="form-group"><label for="modalLocation" id="modalLocationLabel"></label><input type="text" id="modalLocation" name="location"></div>
                <button type="submit" id="userFormSubmitBtn"></button>
            </form>
        </div>
    </div>

    <!-- Model Modal -->
    <div id="modelModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-button">&times;</button>
            <h3 id="modelModalTitle"></h3>
            <form id="modelForm">
                <div class="form-group"><label for="ollamaModelId" id="ollamaModelIdLabel"></label><input type="text" id="ollamaModelId" name="ollamaModelId" required></div>
                <div class="form-group"><label for="displayName" id="displayNameLabel"></label><input type="text" id="displayName" name="displayName" required></div>
                <button type="submit" id="modelFormSubmitBtn"></button>
            </form>
        </div>
    </div>

    <!-- Ollama Model Management Modal -->
    <div id="ollamaModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-button">&times;</button>
            <h3 id="ollamaModalTitle"></h3>
            <form id="ollamaForm">
                <div class="form-group">
                    <label for="ollamaModelManage" id="ollamaModelManageLabel"></label>
                    <input type="text" id="ollamaModelManage" name="modelId" required>
                </div>
                <input type="hidden" id="ollamaAction" name="action">
                <button type="submit" id="ollamaFormSubmitBtn"></button>
            </form>
        </div>
    </div>

    <div id="popupContainer"></div>

    <script>
        // Global functions for dynamic buttons
        window.editUser = async function(userId) {
            try {
                const response = await authenticatedFetch(`/api/admin/users/${userId}`);
                if (!response.ok) throw new Error(lang.error_load_user_data);
                const user = await response.json();
                openModal('userModal', true, user);
            } catch (error) {
                console.error('Error loading user data for editing:', error);
                showPopup(lang.error_load_user_data, 'error');
            }
        }

        window.deleteUser = async function(userId) {
            if (!confirm(lang.confirm_delete_user)) return;
            try {
                const response = await authenticatedFetch(`/api/admin/users/${userId}`, { method: 'DELETE' });
                if (response.ok) {
                    showPopup(lang.success_delete_user, 'success');
                    loadUsers();
                } else {
                    const data = await response.json();
                    showPopup(data.message || lang.error_delete_user, 'error');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showPopup(lang.error_unexpected, 'error');
            }
        }

        window.deleteModel = async function(modelId) {
            const decodedModelId = decodeURIComponent(modelId);
            if (!confirm(lang.confirm_delete_model.replace('%model', decodedModelId))) return;
            try {
                const response = await authenticatedFetch(`/api/admin/models/${encodeURIComponent(decodedModelId)}`, { method: 'DELETE' });
                if (response.ok) {
                    showPopup(lang.success_delete_model, 'success');
                    loadModels();
                } else {
                    const data = await response.json();
                    showPopup(data.message || lang.error_delete_model, 'error');
                }
            } catch (error) {
                console.error('Error deleting model:', error);
                showPopup(lang.error_unexpected, 'error');
            }
        }

        // NEU: Global function for deleting integration
        window.deleteIntegration = async function(integrationId) {
            if (!confirm(lang.confirm_delete_integration.replace('%id', integrationId))) return;
            try {
                const response = await authenticatedFetch(`/api/admin/integrations/${integrationId}`, { method: 'DELETE' });
                if (response.ok) {
                    showPopup(lang.success_delete_integration, 'success');
                    loadIntegrationsAdmin();
                } else {
                    const data = await response.json();
                    showPopup(data.message || lang.error_delete_integration, 'error');
                }
            } catch (error) {
                console.error('Error deleting integration:', error);
                showPopup(lang.error_unexpected, 'error');
            }
        }

        // Utility functions
        async function authenticatedFetch(url, options = {}) {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            const headers = {
                'Authorization': `Bearer ${token}`,
                ...options.headers
            };
            // Only set Content-Type for JSON bodies, not for FormData
            if (options.body instanceof FormData) {
                delete headers['Content-Type']; // Browser sets this automatically for FormData
            } else if (options.body && typeof options.body === 'object') {
                headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(options.body);
            }
            const response = await fetch(url, { ...options, headers });
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('authToken');
                window.location.href = '/login.html';
                throw new Error('Not authenticated or authorized.');
            }
            return response;
        }

        const popupContainer = document.getElementById('popupContainer');
        function showPopup(message, type = 'error') {
            const popup = document.createElement('div');
            popup.classList.add('popup', type);
            popup.textContent = message;
            popupContainer.appendChild(popup);
            setTimeout(() => popup.remove(), 5000);
        }

        function openModal(modalId, isEdit = false, data = {}) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';

            if (modalId === 'userModal') {
                const form = document.getElementById('userForm');
                form.reset();
                document.getElementById('userModalTitle').textContent = isEdit ? lang.edit_user_title : lang.create_user_title;
                document.getElementById('userFormSubmitBtn').textContent = isEdit ? lang.edit_user_submit : lang.create_user_submit;
                
                if (isEdit) {
                    document.getElementById('userId').value = data.id;
                    document.getElementById('modalUsername').value = data.username;
                    document.getElementById('modalEmail').value = data.email;
                    document.getElementById('modalFirstName').value = data.firstName;
                    document.getElementById('modalMaxTokens').value = data['max-tokens'];
                    document.getElementById('modalAdmin').checked = data.admin;
                    document.getElementById('modalPersonalPrompt').value = data.profile['personal-ai-prompt'] || '';
                    document.getElementById('modalLocation').value = data.profile.location || '';
                    document.getElementById('modalPassword').removeAttribute('required');
                } else {
                    document.getElementById('userId').value = '';
                    document.getElementById('modalPassword').setAttribute('required', 'required');
                }
            } else if (modalId === 'modelModal') {
                document.getElementById('modelForm').reset();
                document.getElementById('modelModalTitle').textContent = lang.add_model_title;
                document.getElementById('modelFormSubmitBtn').textContent = lang.add_model_submit;
            } else if (modalId === 'ollamaModal') {
                document.getElementById('ollamaForm').reset();
                document.getElementById('ollamaModalTitle').textContent = document.getElementById('ollamaAction').value === 'pull' ? lang.download_model : lang.remove_model;
                document.getElementById('ollamaFormSubmitBtn').textContent = document.getElementById('ollamaAction').value === 'pull' ? lang.download_model_submit : lang.remove_model_submit;
                document.getElementById('ollamaFormSubmitBtn').className = document.getElementById('ollamaAction').value === 'remove' ? 'danger' : '';
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Language file loading
            let lang = {};
            let userLang = 'EN';
            async function loadLangFile(langCode) {
                try {
                    const res = await fetch(`/Lang_${langCode}.json`);
                    if (!res.ok) throw new Error('Language file not found');
                    lang = await res.json();
                } catch (error) {
                    console.error('Error loading language file:', error);
                }
            }
            async function getUserLanguage() {
                try {
                    const token = localStorage.getItem('authToken');
                    if (!token) return 'EN';
                    const res = await fetch('/api/user/me', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!res.ok) return 'EN';
                    const user = await res.json();
                    return user.panelLanguage || 'EN';
                } catch {
                    return 'EN';
                }
            }
            (async () => {
                userLang = await getUserLanguage();
                await loadLangFile(userLang);

                // Set all UI texts from Lang_EN.json
                document.getElementById('adminPanelTitle').textContent = lang.admin_panel;
                document.getElementById('dashboardNav').textContent = lang.dashboard;
                document.getElementById('usersNav').textContent = lang.users;
                document.getElementById('modelsNav').textContent = lang.models;
                document.getElementById('integrationsNav').textContent = lang.integrations; // NEU
                document.getElementById('configNav').textContent = lang.config;
                document.getElementById('ollamaNav').textContent = lang.ollama;

                document.getElementById('dashboardTitle').textContent = lang.dashboard;
                document.getElementById('tokenTodayTitle').textContent = lang.token_today;
                document.getElementById('tokenTotalTitle').textContent = lang.token_total;
                document.getElementById('cpuUsageTitle').textContent = lang.cpu_usage;
                document.getElementById('ramUsageTitle').textContent = lang.ram_usage;
                document.getElementById('tokensToday').textContent = lang.loading;
                document.getElementById('tokensOverall').textContent = lang.loading;
                document.getElementById('cpuUsage').textContent = lang.loading;
                document.getElementById('ramUsage').textContent = lang.loading;

                document.getElementById('usersTitle').textContent = lang.users;
                document.getElementById('addUserBtnText').textContent = lang.add_user;
                document.getElementById('usernameTh').textContent = lang.username;
                document.getElementById('emailTh').textContent = lang.email;
                document.getElementById('nameTh').textContent = lang.name;
                document.getElementById('maxTokensTh').textContent = lang.max_tokens;
                document.getElementById('usedTokensTh').textContent = lang.used_tokens;
                document.getElementById('adminTh').textContent = lang.admin;
                document.getElementById('actionsTh').textContent = lang.actions;

                document.getElementById('modelsTitle').textContent = lang.models;
                document.getElementById('addModelBtnText').textContent = lang.add_model;
                document.getElementById('modelIdTh').textContent = lang.model_id;
                document.getElementById('displayNameTh').textContent = lang.display_name;
                document.getElementById('actionsModelTh').textContent = lang.actions;

                // NEU: Integrations-Texte
                document.getElementById('integrationsTitle').textContent = lang.integrations;
                document.getElementById('uploadIntegrationBtnText').textContent = lang.upload_integration_btn_text;
                document.getElementById('integrationNameTh').textContent = lang.integration_name;
                document.getElementById('integrationDescriptionTh').textContent = lang.integration_description;
                document.getElementById('integrationAuthorTh').textContent = lang.integration_author;
                document.getElementById('integrationVersionTh').textContent = lang.integration_version;
                document.getElementById('integrationLicenseTh').textContent = lang.integration_license;
                document.getElementById('actionsIntegrationTh').textContent = lang.actions_integration;


                document.getElementById('configTitle').textContent = lang.config;
                document.getElementById('saveConfigBtnText').textContent = lang.save;
                document.getElementById('serverSettingsTitle').textContent = lang.server_settings;
                document.getElementById('mainPortLabel').textContent = lang.main_port_label;
                document.getElementById('sslPortLabel').textContent = lang.ssl_port_label;
                document.getElementById('hostNameLabel').textContent = lang.host_label;
                document.getElementById('trustedDomainsLabel').textContent = lang.trusted_domains_label;
                document.getElementById('ollamaSettingsTitle').textContent = lang.ollama_settings_title;
                document.getElementById('ollamaPortLabel').textContent = lang.ollama_port_label;
                document.getElementById('ollamaHost1Label').textContent = lang.ollama_host1_label;
                document.getElementById('ollamaHost2Label').textContent = lang.ollama_host2_label;
                document.getElementById('emailSettingsTitle').textContent = lang.email_settings_title;
                document.getElementById('smtpEnabledLabel').textContent = lang.smtp_enabled_label;
                document.getElementById('smtpHostLabel').textContent = lang.smtp_host_label;
                document.getElementById('smtpPortLabel').textContent = lang.smtp_port_label;
                document.getElementById('smtpSecureLabel').textContent = lang.smtp_secure_label;
                document.getElementById('smtpUserLabel').textContent = lang.smtp_user_label;
                document.getElementById('smtpPassLabel').textContent = lang.smtp_pass_label;
                document.getElementById('aiSettingsTitle').textContent = lang.ai_settings_title;
                document.getElementById('configLanguageLabel').textContent = lang.config_language_label;
                document.getElementById('systemPromptLabel').textContent = lang.system_prompt_label;
                document.getElementById('aiProtectionTitle').textContent = lang.ai_protection_title;
                document.getElementById('messageGuardEnabledLabel').textContent = lang.message_guard_enabled_label;

                document.getElementById('ollamaTitle').textContent = lang.ollama;
                document.getElementById('downloadModelBtnText').textContent = lang.download_model;
                document.getElementById('removeModelBtnText').textContent = lang.remove_model;
                document.getElementById('serverStatusTitle').textContent = lang.server_status;
                document.getElementById('host1Name').textContent = lang.host1_name_default;
                document.getElementById('host2Name').textContent = lang.host2_name_default;
                document.getElementById('host1Status').textContent = lang.host1_status_checking;
                document.getElementById('host2Status').textContent = lang.host2_status_disabled;

                document.getElementById('settingsBtnText').textContent = lang.settings;
                document.getElementById('logoutBtnText').textContent = lang.logout;
                document.getElementById('usedTokensLabel').textContent = lang.used_tokens;
                document.getElementById('maxTokensLabel').textContent = lang.max_tokens;

                document.getElementById('modalUsernameLabel').textContent = lang.username;
                document.getElementById('modalEmailLabel').textContent = lang.email;
                document.getElementById('modalPasswordLabel').textContent = lang.password;
                document.getElementById('modalFirstNameLabel').textContent = lang.first_name;
                document.getElementById('modalMaxTokensLabel').textContent = lang.max_tokens;
                document.getElementById('modalAdminLabel').textContent = lang.admin;
                document.getElementById('modalPersonalPromptLabel').textContent = lang.personal_prompt;
                document.getElementById('modalLocationLabel').textContent = lang.location;

                document.getElementById('ollamaModelIdLabel').textContent = lang.ollama_model_id_label;
                document.getElementById('displayNameLabel').textContent = lang.display_name;
                document.getElementById('ollamaModelManageLabel').textContent = lang.ollama_model_manage_label;
            })();
            // General initialization
            (async () => {
                try {
                    const response = await fetch('/api/general-config');
                    const config = await response.json();
                    document.getElementById('pageTitle').textContent = config['html-titel'].replace('%name', 'Admin');
                } catch (error) {
                    console.error('Error loading general configuration:', error);
                }
            })();

            // Authentication and user info
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            async function loadUserInfo() {
                try {
                    const response = await authenticatedFetch('/api/user/me');
                    if (!response.ok) throw new Error(lang.error_load_user);
                    const userData = await response.json();
                    if (!userData.admin) {
                        window.location.href = '/chat.html';
                        return;
                    }
                    const usedTokens = userData['used-tokens'] || 0;
                    const maxTokens = userData['max-tokens'] === '--' ? '∞' : userData['max-tokens'];
                    document.getElementById('userTokensSummary').textContent = `${usedTokens} / ${maxTokens} ⚡`;
                    document.getElementById('popupUsedTokens').textContent = usedTokens;
                    document.getElementById('popupMaxTokens').textContent = maxTokens;
                } catch (error) {
                    console.error('Error loading user info:', error);
                }
            }

            function logout() {
                authenticatedFetch('/api/logout', { method: 'POST' })
                    .then(() => {
                        localStorage.removeItem('authToken');
                        window.location.href = '/login.html';
                    })
                    .catch(error => {
                        console.error('Logout failed:', error);
                        showPopup(lang.login_failed, 'error');
                    });
            }
            document.getElementById('logoutBtn').addEventListener('click', logout);

            // UI Interactions
            const navItems = document.querySelectorAll('.admin-nav-item');
            const sections = document.querySelectorAll('.admin-section');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    if (item.dataset.section) {
                        navItems.forEach(nav => nav.classList.remove('active'));
                        item.classList.add('active');
                        sections.forEach(section => section.classList.remove('active'));
                        document.getElementById(`${item.dataset.section}-section`).classList.add('active');
                        
                        switch (item.dataset.section) {
                            case 'dashboard': loadDashboardData(); break;
                            case 'users': loadUsers(); break;
                            case 'models': loadModels(); break;
                            case 'integrations': loadIntegrationsAdmin(); break; // NEU
                            case 'config': loadConfig(); break;
                            case 'ollama': loadOllamaStatus(); break;
                        }
                    }
                });
            });
            
            document.querySelectorAll('.modal-overlay .close-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    closeModal(btn.closest('.modal-overlay').id);
                });
            });

            // Button event listeners
            document.getElementById('addUserBtn').addEventListener('click', () => openModal('userModal'));
            document.getElementById('addModelBtn').addEventListener('click', () => openModal('modelModal'));
            document.getElementById('saveConfigBtn').addEventListener('click', saveConfig);
            document.getElementById('pullModelBtn').addEventListener('click', () => {
                document.getElementById('ollamaAction').value = 'pull';
                openModal('ollamaModal');
            });
            document.getElementById('removeModelBtn').addEventListener('click', () => {
                document.getElementById('ollamaAction').value = 'remove';
                openModal('ollamaModal');
            });
            
            // NEU: Integrations-Upload Form Handling
            const integrationFile = document.getElementById('integrationFile');
            const integrationUploadForm = document.getElementById('integrationUploadForm');
            const selectedFileNameSpan = document.getElementById('selectedFileName');

            integrationFile.addEventListener('change', () => {
                if (integrationFile.files.length > 0) {
                    selectedFileNameSpan.textContent = integrationFile.files[0].name;
                    integrationUploadForm.dispatchEvent(new Event('submit')); // Auto-submit on file select
                } else {
                    selectedFileNameSpan.textContent = '';
                }
            });

            integrationUploadForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (integrationFile.files.length === 0) {
                    showPopup(lang.integration_file_missing, 'error');
                    return;
                }

                const formData = new FormData();
                formData.append('integrationZip', integrationFile.files[0]);

                try {
                    showPopup(lang.upload_integration_progress, 'info'); // Add a new lang key for this
                    const response = await authenticatedFetch('/api/admin/integrations/upload', {
                        method: 'POST',
                        body: formData // FormData is passed directly, authenticatedFetch handles Content-Type
                    });

                    const data = await response.json();
                    if (response.ok) {
                        showPopup(lang.success_upload_integration, 'success');
                        loadIntegrationsAdmin(); // Reload the list after successful upload
                        integrationFile.value = ''; // Clear file input
                        selectedFileNameSpan.textContent = '';
                    } else {
                        showPopup(data.message || lang.error_upload_integration, 'error');
                    }
                } catch (error) {
                    console.error('Error uploading integration:', error);
                    showPopup(lang.error_unexpected, 'error');
                }
            });


            const userInfoFooter = document.getElementById('userInfoFooter');
            const userInfoPopup = document.getElementById('userInfoPopup');
            userInfoFooter.addEventListener('click', (event) => {
                if (!userInfoPopup.contains(event.target)) {
                    userInfoPopup.classList.toggle('active');
                }
            });
            document.addEventListener('click', (event) => {
                if (!userInfoFooter.contains(event.target)) {
                    userInfoPopup.classList.remove('active');
                }
            });

            // Data loading functions
            async function loadDashboardData() {
                try {
                    const response = await authenticatedFetch('/api/admin/stats');
                    if (!response.ok) throw new Error(lang.error_load_stats);
                    const stats = await response.json();
                    const today = new Date().toISOString().slice(0, 10);
                    document.getElementById('tokensToday').textContent = stats.dailyStats[today]?.totalTokensUsed || 0;
                    document.getElementById('tokensOverall').textContent = stats.overallStats.totalTokensUsed || 0;
                    document.getElementById('cpuUsage').textContent = `${(stats.overallStats.cpuUsageAvg * 100).toFixed(2)}%`;
                    document.getElementById('ramUsage').textContent = `${(stats.overallStats.ramUsageAvg * 100).toFixed(2)}%`;
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                    showPopup(lang.error_load_stats, 'error');
                }
            }

            async function loadUsers() {
                try {
                    const response = await authenticatedFetch('/api/admin/users');
                    if (!response.ok) throw new Error(lang.error_load_users);
                    const users = await response.json();
                    const tableBody = document.getElementById('userTableBody');
                    tableBody.innerHTML = '';
                    users.forEach(user => {
                        const row = tableBody.insertRow();
                        row.innerHTML = `
                            <td>${user.id}</td>
                            <td>${user.username}</td>
                            <td>${user.email}</td>
                            <td>${user.firstName}</td>
                            <td>${user['max-tokens']}</td>
                            <td>${user['used-tokens']}</td>
                            <td>${user.admin ? '<i class="fas fa-check-circle" style="color: var(--erfolgs-farbe);"></i>' : '<i class="fas fa-times-circle" style="color: var(--fehler-farbe);"></i>'}</td>
                            <td class="actions">
                                <button onclick="editUser(${user.id})"><i class="fas fa-edit"></i></button>
                                <button class="danger" onclick="deleteUser(${user.id})"><i class="fas fa-trash"></i></button>
                            </td>
                        `;
                    });
                } catch (error) {
                    console.error('Error loading users:', error);
                    showPopup(lang.error_load_users, 'error');
                }
            }

            async function loadModels() {
                try {
                    const response = await authenticatedFetch('/api/admin/models');
                    if (!response.ok) throw new Error(lang.error_load_models);
                    const models = await response.json();
                    const tableBody = document.getElementById('modelTableBody');
                    tableBody.innerHTML = '';
                    for (const modelId in models) {
                        const row = tableBody.insertRow();
                        const encodedModelId = encodeURIComponent(modelId);
                        row.innerHTML = `
                            <td>${modelId}</td>
                            <td>${models[modelId]}</td>
                            <td class="actions">
                                <button class="danger" onclick="deleteModel('${encodedModelId}')"><i class="fas fa-trash"></i></button>
                            </td>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading models:', error);
                    showPopup(lang.error_load_models, 'error');
                }
            }

            // NEU: Funktion zum Laden und Anzeigen von Integrationen
            async function loadIntegrationsAdmin() {
                try {
                    const response = await authenticatedFetch('/api/admin/integrations');
                    if (!response.ok) throw new Error(lang.error_load_integrations); // New lang key
                    const integrations = await response.json();
                    const tableBody = document.getElementById('integrationTableBody');
                    tableBody.innerHTML = '';
                    integrations.forEach(integration => {
                        const row = tableBody.insertRow();
                        row.innerHTML = `
                            <td>${integration.name}</td>
                            <td>${integration.description}</td>
                            <td>${integration.author}</td>
                            <td>${integration.version}</td>
                            <td>${integration.license}</td>
                            <td class="actions">
                                <button class="danger" onclick="deleteIntegration('${integration.id}')"><i class="fas fa-trash"></i></button>
                            </td>
                        `;
                    });
                } catch (error) {
                    console.error('Error loading integrations:', error);
                    showPopup(lang.error_load_integrations, 'error'); // New lang key
                }
            }

            async function loadConfig() {
                try {
                    const response = await authenticatedFetch('/api/admin/config');
                    if (!response.ok) throw new Error(lang.error_load_config);
                    const config = await response.json();
                    
                    document.getElementById('mainPort').value = config['main-port'];
                    document.getElementById('sslPort').value = config['ssl-port'];
                    document.getElementById('hostName').value = config.host;
                    document.getElementById('trustedDomains').value = config['trusted-domains'].join(', ');
                    
                    document.getElementById('ollamaPort').value = config.ollama.port;
                    document.getElementById('ollamaHost1').value = config.ollama.host1;
                    document.getElementById('ollamaHost2').value = config.ollama.host2;
                    
                    document.getElementById('smtpEnabled').checked = config.smtp?.enabled !== false;
                    document.getElementById('smtpHost').value = config.smtp?.host || '';
                    document.getElementById('smtpPort').value = config.smtp?.port || '';
                    document.getElementById('smtpSecure').checked = config.smtp?.secure || false;
                    document.getElementById('smtpUser').value = config.smtp?.auth?.user || '';
                    document.getElementById('smtpPass').value = config.smtp?.auth?.pass || '';
                    
                    document.getElementById('configLanguage').value = config.sprache;
                    document.getElementById('systemPrompt').value = config['system-prompt'];
                    
                    document.getElementById('messageGuardEnabled').checked = config['message-guard-enabled'] !== false;
                } catch (error) {
                    console.error('Error loading configuration:', error);
                    showPopup(lang.error_load_config, 'error');
                }
            }

            async function saveConfig() {
                try {
                    const updatedConfig = {
                        'main-port': parseInt(document.getElementById('mainPort').value),
                        'ssl-port': parseInt(document.getElementById('sslPort').value),
                        'host': document.getElementById('hostName').value,
                        'trusted-domains': document.getElementById('trustedDomains').value.split(',').map(d => d.trim()),
                        'ollama': {
                            'port': parseInt(document.getElementById('ollamaPort').value),
                            'host1': document.getElementById('ollamaHost1').value,
                            'host2': document.getElementById('ollamaHost2').value
                        },
                        'smtp': {
                            'enabled': document.getElementById('smtpEnabled').checked,
                            'host': document.getElementById('smtpHost').value,
                            'port': parseInt(document.getElementById('smtpPort').value),
                            'secure': document.getElementById('smtpSecure').checked,
                            'auth': {
                                'user': document.getElementById('smtpUser').value,
                                'pass': document.getElementById('smtpPass').value
                            }
                        },
                        'sprache': document.getElementById('configLanguage').value,
                        'system-prompt': document.getElementById('systemPrompt').value,
                        'message-guard-enabled': document.getElementById('messageGuardEnabled').checked
                    };

                    const response = await authenticatedFetch('/api/admin/config', {
                        method: 'PUT',
                        body: updatedConfig // authenticatedFetch will stringify this
                    });

                    if (response.ok) {
                        showPopup(lang.success_save_config, 'success');
                    } else {
                        const data = await response.json();
                        showPopup(data.message || lang.error_save_config, 'error');
                    }
                } catch (error) {
                    console.error('Error saving configuration:', error);
                    showPopup(lang.error_unexpected, 'error');
                }
            }

            async function loadOllamaStatus() {
                try {
                    const configResponse = await authenticatedFetch('/api/admin/config');
                    const config = await configResponse.json();
                    
                    document.getElementById('host1Name').textContent = config.ollama.host1;
                    document.getElementById('host2Name').textContent = config.ollama.host2;
                    
                    try {
                        const host1 = config.ollama.host1 === 'localhost' ? '127.0.0.1' : config.ollama.host1;
                        const host1Response = await fetch(`http://${host1}:${config.ollama.port}/api/version`);
                        if (host1Response.ok) {
                            const version = await host1Response.json();
                            document.getElementById('host1Status').innerHTML = `<span style="color: var(--erfolgs-farbe);">Online (v${version.version || 'unknown'})</span>`;
                        } else {
                            document.getElementById('host1Status').innerHTML = `<span style="color: var(--fehler-farbe);">Offline</span>`;
                        }
                    } catch (error) {
                        document.getElementById('host1Status').innerHTML = `<span style="color: var(--fehler-farbe);">Offline</span>`;
                    }
                    
                    if (config.ollama.host2 !== 'none') {
                        try {
                            const host2 = config.ollama.host2 === 'localhost' ? '127.0.0.1' : config.ollama.host2;
                            const host2Response = await fetch(`http://${host2}:${config.ollama.port}/api/version`);
                            if (host2Response.ok) {
                                const version = await host2Response.json();
                                document.getElementById('host2Status').innerHTML = `<span style="color: var(--erfolgs-farbe);">Online (v${version.version || 'unknown'})</span>`;
                            } else {
                                document.getElementById('host2Status').innerHTML = `<span style="color: var(--fehler-farbe);">Offline</span>`;
                            }
                        } catch (error) {
                            document.getElementById('host2Status').innerHTML = `<span style="color: var(--fehler-farbe);">Offline</span>`;
                        }
                    } else {
                        document.getElementById('host2Status').innerHTML = `<span style="color: var(--sekundaer-text-farbe);">Deaktiviert</span>`;
                    }
                } catch (error) {
                    console.error('Error loading Ollama status:', error);
                    showPopup(lang.error_load_config, 'error');
                }
            }

            // Form handlers
            document.getElementById('userForm').addEventListener('submit', async (event) => {
                event.preventDefault();
                const userId = document.getElementById('userId').value;
                const isEdit = !!userId;
                const formData = new FormData(event.target);
                const userData = Object.fromEntries(formData.entries());
                userData.admin = document.getElementById('modalAdmin').checked;
                if (isEdit && userData.password === '') delete userData.password;
                
                userData.profile = {
                    'personal-ai-prompt': userData['personal-ai-prompt'],
                    'location': userData.location
                };
                delete userData['personal-ai-prompt'];
                delete userData.location;

                try {
                    const url = isEdit ? `/api/admin/users/${userId}` : '/api/admin/users';
                    const method = isEdit ? 'PUT' : 'POST';
                    const response = await authenticatedFetch(url, { method, body: userData });
                    const data = await response.json();
                    if (response.ok) {
                        showPopup(isEdit ? lang.success_update_user : lang.success_create_user, 'success');
                        closeModal('userModal');
                        loadUsers();
                    } else {
                        showPopup(data.message || lang.error_save_user, 'error');
                    }
                } catch (error) {
                    console.error('Error saving user:', error);
                    showPopup(lang.error_unexpected, 'error');
                }
            });

            document.getElementById('modelForm').addEventListener('submit', async (event) => {
                event.preventDefault();
                const ollamaModelId = document.getElementById('ollamaModelId').value;
                const displayName = document.getElementById('displayName').value;
                try {
                    const response = await authenticatedFetch('/api/admin/models', {
                        method: 'POST',
                        body: { ollamaModelId, displayName }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showPopup(lang.success_add_model, 'success');
                        closeModal('modelModal');
                        loadModels();
                    } else {
                        showPopup(data.message || lang.error_add_model, 'error');
                    }
                } catch (error) {
                    console.error('Error adding model:', error);
                    showPopup(lang.error_unexpected, 'error');
                }
            });

            document.getElementById('ollamaForm').addEventListener('submit', async (event) => {
                event.preventDefault();
                const modelId = document.getElementById('ollamaModelManage').value;
                const action = document.getElementById('ollamaAction').value;
                
                try {
                    showPopup(lang.download_started, 'info');
                    
                    const response = await authenticatedFetch('/api/admin/models/manage', {
                        method: 'POST',
                        body: { action, modelId }
                    });
                    
                    const data = await response.json();
                    if (response.ok) {
                        const resultsDiv = document.getElementById('ollamaResults');
                        resultsDiv.innerHTML = `<h4>${lang.result}:</h4>`;
                        data.results.forEach(result => {
                            const div = document.createElement('div');
                            div.className = `result-item ${result.success ? 'success' : 'error'}`;
                            div.innerHTML = `<strong>${result.host}:</strong> ${result.message}`;
                            resultsDiv.appendChild(div);
                        });
                        
                        const successCount = data.results.filter(r => r.success).length;
                        if (successCount > 0) {
                            showPopup(`${action === 'pull' ? lang.success_download : lang.success_remove} ${successCount} server(s).`, 'success');
                        } else {
                            showPopup(lang.failed_all, 'error');
                        }
                        
                        closeModal('ollamaModal');
                        if (action === 'remove') loadModels();
                    } else {
                        showPopup(data.message || lang.error_manage_model, 'error');
                    }
                } catch (error) {
                    console.error('Error managing Ollama model:', error);
                    showPopup(lang.error_unexpected, 'error');
                }
            });

            // Initial load
            loadUserInfo();
            loadDashboardData();
        });
    </script>
</body>
</html>
