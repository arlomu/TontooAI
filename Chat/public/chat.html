<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Tontoo AI | Chat</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="main-layout">
        <div class="sidebar" id="chatSidebar">
            <div class="chat-sidebar-header">
                <img src="/icon.png" alt="Icon description" width="52" height="52">
                <button id="newChatBtn"><span style="font-size:30px;">+</span><span id="newChatBtnText" style="font-size:20px;"></span></button>
                <p id="toggleSidebarBtn" title=""></p>
            </div>
            <div class="chat-list" id="chatList">
                <!-- Chat list will be dynamically loaded here -->
            </div>
        </div>

        <div class="content-area">
            <div class="chat-main">
                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will be dynamically loaded here -->
                </div>
                <div class="loading-indicator" id="loadingIndicator">
                    <i class="fas fa-spinner fa-spin"></i><span id="loadingMessage"></span>
                </div>
                <div class="chat-input-area">
                    <div class="feature-menu-container">
                        <button id="featureMenuBtn" title="Features">
                            <i class="fas fa-plus"></i>
                        </button>
                        <div class="feature-menu" id="featureMenu">
                            <button class="feature-menu-item" id="codeInterpreterBtn" data-feature-type="Codeinterpreter">
                                <i class="fas fa-code"></i><span id="codeInterpreterText"></span>
                            </button>
                            <button class="feature-menu-item" id="websearchBtn" data-feature-type="Websearch">
                                <i class="fas fa-search"></i><span id="websearchText"></span>
                            </button>
                            <button class="feature-menu-item" id="deepSearchBtn" data-feature-type="DeepSearch">
                                <i class="fas fa-search-plus"></i><span id="deepSearchText"></span>
                            </button>
                            <button class="feature-menu-item" id="integrationsMenuBtn" data-feature-type="Integrations">
                                <i class="fas fa-plug"></i><span id="integrationsText"></span>
                                <div class="integrations-submenu" id="integrationsSubmenu">
                                    <!-- Integrations will be dynamically loaded here -->
                                </div>
                            </button>
                        </div>
                    </div>
                    
                    <textarea id="messageInput" placeholder="" rows="1"></textarea>
                    <button id="sendMessageBtn"><i class="fas fa-paper-plane"></i></button>
                    <select id="modelSelector" class="model-selector"></select>
                </div>
            </div>

            <div class="user-info-footer" id="userInfoFooter">
                <i class="fas fa-user icon"></i>
                <span id="userTokensSummary"></span>
                <div class="user-info-popup" id="userInfoPopup">
                    <p><span id="usedTokensText"></span>: <span id="popupUsedTokens"></span></p>
                    <p><span id="maxTokensText"></span>: <span id="popupMaxTokens"></span></p>
                    <button onclick="window.location.href='/settings.html'"><i class="fas fa-cog"></i><span id="settingsBtnText"></span></button>
                    <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i><span id="logoutBtnText"></span></button>
                </div>
            </div>
        </div>
    </div>
    <div id="popupContainer"></div>
    <script>
        // Global Functions
        window.copyCode = function(button) {
            const codeElement = button.closest('.code-block, .execution-code, .execution-output').querySelector('code');
            const textToCopy = codeElement.textContent;
            navigator.clipboard.writeText(textToCopy).then(() => {
                button.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => { button.innerHTML = '<i class="fas fa-copy"></i>'; }, 2000);
                showPopup(lang.copied || 'Copied!', 'success');
            }).catch(err => {
                console.error('Error copying code:', err);
                showPopup(lang.error || 'Error copying code.', 'error');
            });
        };

        let activeFeature = null; // Can be 'Codeinterpreter', 'Websearch', 'DeepSearch', 'Integrations'
        let activeIntegrationId = null; // Only set if activeFeature is 'Integrations'

        function toggleFeature(featureName, integrationId = null) {
            console.log('Toggling feature:', featureName, 'Integration ID:', integrationId);

            const allFeatureButtons = document.querySelectorAll('.feature-menu-item');
            const integrationsSubmenuItems = document.querySelectorAll('.integration-submenu-item');

            // Deactivate all features and integrations
            allFeatureButtons.forEach(btn => btn.classList.remove('active'));
            integrationsSubmenuItems.forEach(item => item.classList.remove('active'));
            
            // If the same feature/integration is selected again, deactivate it
            if (activeFeature === featureName && activeIntegrationId === integrationId) {
                activeFeature = null;
                activeIntegrationId = null;
                showPopup(`${featureName} ${lang.disabled || 'disabled'}.`, 'info');
                return;
            }

            // Activate the new feature/integration
            activeFeature = featureName;
            activeIntegrationId = integrationId;

            if (featureName === 'Integrations' && integrationId) {
                // Activate the main integrations button and the specific submenu item
                document.getElementById('integrationsMenuBtn')?.classList.add('active');
                document.querySelector(`.integration-submenu-item[data-integration-id="${integrationId}"]`)?.classList.add('active');
                showPopup(`${lang.integrations || 'Integration'} "${integrationId}" ${lang.enabled || 'enabled'}.`, 'success');
            } else {
                // Activate the specific feature button
                const buttonIdMap = {
                    'Codeinterpreter': 'codeInterpreterBtn',
                    'Websearch': 'websearchBtn',
                    'DeepSearch': 'deepSearchBtn'
                };
                document.getElementById(buttonIdMap[featureName])?.classList.add('active');
                showPopup(`${featureName} ${lang.enabled || 'enabled'}.`, 'success');
            }
            
            document.getElementById('featureMenu').classList.remove('active'); // Close the main menu
            document.getElementById('integrationsSubmenu')?.classList.remove('active'); // Close the integrations submenu
        }

        async function authenticatedFetch(url, options = {}) {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                ...options.headers
            };
            const response = await fetch(url, { ...options, headers });
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('authToken');
                window.location.href = '/login.html';
                throw new Error(lang.error_unauthorized || 'Not authenticated or unauthorized.');
            }
            return response;
        }

        const popupContainer = document.getElementById('popupContainer');
        function showPopup(message, type = 'error') {
            const popup = document.createElement('div');
            popup.classList.add('popup', type);
            popup.textContent = message;
            popupContainer.appendChild(popup);
            setTimeout(() => popup.remove(), 5000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            let lang = {};
            let userLang = 'EN';
            async function loadLangFile(langCode) {
                try {
                    const res = await fetch(`/Lang_${langCode}.json`);
                    lang = await res.json();
                } catch (error) {
                    console.error('Error loading language file:', error);
                }
            }
            async function getUserLanguage() {
                try {
                    const token = localStorage.getItem('authToken');
                    if (!token) return 'EN';
                    const res = await fetch('/api/user/me', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!res.ok) return 'EN';
                    const user = await res.json();
                    return user.panelLanguage || 'EN';
                } catch {
                    return 'EN';
                }
            }
            (async () => {
                userLang = await getUserLanguage();
                await loadLangFile(userLang);

                document.getElementById('newChatBtnText').textContent = lang.new_chat || 'New Chat';
                document.getElementById('toggleSidebarBtn').title = lang.chat || 'Chat';
                document.getElementById('messageInput').placeholder = lang.send || 'Enter message...';
                document.getElementById('featureMenuBtn').title = lang.features || 'Features';
                document.getElementById('codeInterpreterText').textContent = lang.code_interpreter || 'Code Interpreter';
                document.getElementById('websearchText').textContent = lang.web_search || 'Web Search';
                document.getElementById('deepSearchText').textContent = lang.deep_search || 'Deep Search';
                document.getElementById('integrationsText').textContent = lang.integrations || 'Integrations';
                document.getElementById('usedTokensText').textContent = lang.token_used || 'Used';
                document.getElementById('maxTokensText').textContent = lang.max_tokens || 'Max';
                document.getElementById('settingsBtnText').textContent = lang.settings || 'Settings';
                document.getElementById('logoutBtnText').textContent = lang.logout || 'Logout';
            })();

            const featureMenuBtn = document.getElementById('featureMenuBtn');
            const featureMenu = document.getElementById('featureMenu');
            const integrationsMenuBtn = document.getElementById('integrationsMenuBtn');
            const integrationsSubmenu = document.getElementById('integrationsSubmenu');
            
            featureMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                featureMenu.classList.toggle('active');
                integrationsSubmenu.classList.remove('active');
            });
            
            integrationsMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                integrationsSubmenu.classList.toggle('active');
            });

            document.addEventListener('click', (e) => {
                if (!featureMenu.contains(e.target) && e.target !== featureMenuBtn) {
                    featureMenu.classList.remove('active');
                }
                if (!integrationsSubmenu.contains(e.target) && e.target !== integrationsMenuBtn) {
                    integrationsSubmenu.classList.remove('active');
                }
            });
            
            featureMenu.addEventListener('click', (e) => {
                if (e.target.closest('.feature-menu-item') && !e.target.closest('#integrationsMenuBtn')) {
                    const featureType = e.target.closest('.feature-menu-item').dataset.featureType;
                    if (featureType) {
                        toggleFeature(featureType);
                    }
                }
                e.stopPropagation();
            });

            integrationsSubmenu.addEventListener('click', (e) => {
                const integrationItem = e.target.closest('.integration-submenu-item');
                if (integrationItem) {
                    const integrationId = integrationItem.dataset.integrationId;
                    toggleFeature('Integrations', integrationId);
                }
                e.stopPropagation();
            });

            const chatSidebar = document.getElementById('chatSidebar');
            const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
            const newChatBtn = document.getElementById('newChatBtn');
            const chatList = document.getElementById('chatList');
            const chatMessages = document.getElementById('chatMessages');
            const messageInput = document.getElementById('messageInput');
            const sendMessageBtn = document.getElementById('sendMessageBtn');
            const modelSelector = document.getElementById('modelSelector');
            const logoutBtn = document.getElementById('logoutBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const loadingMessage = document.getElementById('loadingMessage');

            let currentChatId = null;
            let isGeneratingResponse = false;
            let abortController = new AbortController();
            let currentMessageId = null;

            (async () => {
                try {
                    const response = await fetch('/api/general-config');
                    const config = await response.json();
                    document.getElementById('pageTitle').textContent = config['html-titel'].replace('%name', lang.chat || 'Chat');
                } catch (error) {
                    console.error('Error loading general configuration:', error);
                }
            })();
            
            async function loadUserInfo() {
                try {
                    const response = await authenticatedFetch('/api/user/me');
                    if (!response.ok) throw new Error(lang.error_load_user || 'User data could not be loaded.');
                    const userData = await response.json();
                    const usedTokens = userData['used-tokens'] || 0;
                    const maxTokens = userData['max-tokens'] === '--' ? '∞' : userData['max-tokens'];

                    document.getElementById('userTokensSummary').textContent = `${usedTokens} / ${maxTokens} ⚡`;
                    document.getElementById('popupUsedTokens').textContent = usedTokens;
                    document.getElementById('popupMaxTokens').textContent = maxTokens;

                    if (userData['max-tokens'] !== '--' && usedTokens >= parseInt(userData['max-tokens'])) {
                        messageInput.disabled = true;
                        sendMessageBtn.disabled = true;
                        messageInput.placeholder = lang.token_limit_reached || 'Daily token limit reached.';
                        showPopup(lang.token_limit_reached || 'Your daily token limit is reached.', 'error');
                    } else {
                        messageInput.disabled = false;
                        sendMessageBtn.disabled = false;
                        messageInput.placeholder = lang.send || 'Enter message...';
                    }
                } catch (error) {
                    console.error('Error loading user info:', error);
                    showPopup(lang.error_load_user || 'Error loading user info.', 'error');
                }
            }

            function logout() {
                authenticatedFetch('/api/logout', { method: 'POST' })
                    .then(() => {
                        localStorage.removeItem('authToken');
                        window.location.href = '/login.html';
                    })
                    .catch(error => {
                        console.error('Logout failed:', error);
                        showPopup(lang.error || 'Logout failed.', 'error');
                    });
            }
            logoutBtn.addEventListener('click', logout);
            
            const userInfoFooter = document.getElementById('userInfoFooter');
            const userInfoPopup = document.getElementById('userInfoPopup');
            userInfoFooter.addEventListener('click', (event) => {
                if (!userInfoPopup.contains(event.target)) userInfoPopup.classList.toggle('active');
            });
            document.addEventListener('click', (event) => {
                if (!userInfoFooter.contains(event.target)) userInfoPopup.classList.remove('active');
            });

            toggleSidebarBtn.addEventListener('click', () => {
                chatSidebar.classList.toggle('collapsed');
            });

            newChatBtn.addEventListener('click', () => {
                if (isGeneratingResponse) {
                    stopGeneration();
                    return;
                }
                currentChatId = null;
                chatMessages.innerHTML = '';
                document.querySelectorAll('.chat-list-item').forEach(item => item.classList.remove('active'));
                messageInput.focus();
            });

            async function loadChatList() {
                try {
                    const response = await authenticatedFetch('/api/chats');
                    if (!response.ok) throw new Error(lang.error || 'Chat list could not be loaded.');
                    const chats = await response.json();
                    chatList.innerHTML = '';
                    const sortedChats = chats.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    sortedChats.forEach(chat => {
                        const chatItem = document.createElement('div');
                        chatItem.classList.add('chat-list-item');
                        chatItem.dataset.chatId = chat.id;
                        if (currentChatId === chat.id) chatItem.classList.add('active');
                        chatItem.innerHTML = `
                            <span class="chat-list-item-title">${chat.title}</span>
                            <div class="chat-list-item-actions">
                                <button class="rename-chat-btn" data-chat-id="${chat.id}" title="${lang.rename || 'Rename'}"><i class="fas fa-edit"></i></button>
                                <button class="delete-chat-btn danger" data-chat-id="${chat.id}" title="${lang.delete || 'Delete'}"><i class="fas fa-trash"></i></button>
                            </div>`;
                        chatList.appendChild(chatItem);
                    });
                } catch (error) {
                    console.error('Error loading chat list:', error);
                    showPopup(lang.error || 'Error loading chat list.', 'error');
                }
            }

            chatList.addEventListener('click', (e) => {
                const target = e.target;
                const chatItem = target.closest('.chat-list-item');
                if (!chatItem) return;

                const chatId = chatItem.dataset.chatId;
                if (target.closest('.rename-chat-btn')) {
                    renameChat(chatId);
                } else if (target.closest('.delete-chat-btn')) {
                    deleteChat(chatId);
                } else {
                    selectChat(chatId);
                }
            });

            async function selectChat(chatId) {
                if (isGeneratingResponse) {
                    stopGeneration();
                    return;
                }
                currentChatId = chatId;
                document.querySelectorAll('.chat-list-item').forEach(item => item.classList.remove('active'));
                document.querySelector(`.chat-list-item[data-chat-id="${chatId}"]`)?.classList.add('active');
                try {
                    const response = await authenticatedFetch(`/api/chats/${chatId}`);
                    if (!response.ok) throw new Error(lang.error || 'Chat history could not be loaded.');
                    const chatData = await response.json();
                    renderChatMessages(chatData.messages);
                } catch (error) {
                    console.error('Error loading chat history:', error);
                    showPopup(lang.error || 'Error loading chat history.', 'error');
                }
            }

            async function renameChat(chatId) {
                const newTitle = prompt(lang.rename || 'Enter new chat name:');
                if (newTitle && newTitle.trim()) {
                    try {
                        await authenticatedFetch(`/api/chats/${chatId}/rename`, {
                            method: 'POST',
                            body: JSON.stringify({ title: newTitle.trim() })
                        });
                        loadChatList();
                    } catch (error) {
                        showPopup(lang.error || 'Error renaming chat.', 'error');
                    }
                }
            }

            async function deleteChat(chatId) {
                if (confirm(lang.confirm_delete_chat || 'Are you sure you want to delete this chat?')) {
                    try {
                        await authenticatedFetch(`/api/chats/${chatId}`, { method: 'DELETE' });
                        if (currentChatId === chatId) {
                            currentChatId = null;
                            chatMessages.innerHTML = '';
                        }
                        loadChatList();
                    } catch (error) {
                        showPopup(lang.error || 'Error deleting chat.', 'error');
                    }
                }
            }
            
            async function loadModels() {
                try {
                    const response = await authenticatedFetch('/api/models');
                    if (!response.ok) throw new Error(lang.error_load_models || 'Models could not be loaded.');
                    const models = await response.json();
                    modelSelector.innerHTML = '';
                    if (Object.keys(models).length === 0) {
                        modelSelector.innerHTML = `<option value="">${lang.no_models || 'No models available'}</option>`;
                        sendMessageBtn.disabled = true;
                        messageInput.disabled = true;
                        messageInput.placeholder = lang.no_models_configured || 'No models configured.';
                    } else {
                        for (const modelId in models) {
                            const option = document.createElement('option');
                            option.value = modelId;
                            option.textContent = models[modelId];
                            modelSelector.appendChild(option);
                        }
                    }
                } catch (error) {
                    console.error('Error loading models:', error);
                    showPopup(lang.error_load_models || 'Error loading models.', 'error');
                }
            }

            async function loadIntegrationsUI() {
                try {
                    const response = await authenticatedFetch('/api/integrations');
                    if (!response.ok) throw new Error(lang.error || 'Integrations could not be loaded.');
                    const integrations = await response.json();
                    integrationsSubmenu.innerHTML = '';

                    if (integrations.length === 0) {
                        integrationsSubmenu.innerHTML = `<div class="integration-submenu-item disabled">${lang.no_integrations || 'No integrations found'}</div>`;
                    } else {
                        integrations.forEach(integration => {
                            const integrationItem = document.createElement('button');
                            integrationItem.classList.add('integration-submenu-item');
                            integrationItem.dataset.integrationId = integration.id;
                            integrationItem.innerHTML = `<img src="/api/integrations/icon/${integration.id}" alt="${integration.name} Icon" class="integration-icon"> ${integration.name}`;
                            integrationsSubmenu.appendChild(integrationItem);
                        });
                    }
                } catch (error) {
                    console.error('Error loading integrations:', error);
                    showPopup(lang.error || 'Error loading integrations.', 'error');
                }
            }

            async function stopGeneration() {
                if (!isGeneratingResponse) return;
                
                try {
                    const response = await authenticatedFetch('/api/stop', {
                        method: 'POST',
                        body: JSON.stringify({ messageId: currentMessageId })
                    });
                    
                    if (response.ok) {
                        abortController.abort();
                        isGeneratingResponse = false;
                        currentMessageId = null;
                        sendMessageBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                        messageInput.disabled = false;
                        messageInput.focus();
                        loadingIndicator.classList.remove('active');
                    }
                } catch (error) {
                    console.error('Error stopping generation:', error);
                    showPopup(lang.error || 'Error stopping generation.', 'error');
                }
            }

            function escapeHtml(text) {
                return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            }

            function formatMessageContent(content, websearchResults = null, deepsearchResults = null, codeExecutionResults = null, integrationResults = null) {
                const codeBlockPlaceholders = [];
                content = content.replace(/```([\s\S]*?)```/g, (match, codeContent) => {
                    const placeholder = `___CODE_BLOCK_${codeBlockPlaceholders.length}___`;
                    codeBlockPlaceholders.push({ 
                        type: 'block', 
                        content: codeContent.trim(),
                        placeholder
                    });
                    return placeholder;
                });

                const inlineCodePlaceholders = [];
                content = content.replace(/`([^`]+)`/g, (match, codeContent) => {
                    const placeholder = `___INLINE_CODE_${inlineCodePlaceholders.length}___`;
                    inlineCodePlaceholders.push({
                        type: 'inline',
                        content: codeContent,
                        placeholder
                    });
                    return placeholder;
                });

                let formattedContent = escapeHtml(content);
                
                formattedContent = formattedContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                formattedContent = formattedContent.replace(/\*(.*?)\*/g, '<em>$1</em>');
                formattedContent = formattedContent.replace(/\n/g, '<br>');
                
                codeBlockPlaceholders.forEach(item => {
                    const language = item.content.split('\n')[0].match(/^(\w+)/);
                    const lang = language ? language[1] : 'text';
                    const code = language ? item.content.substring(language[0].length).trim() : item.content;
                    
                    formattedContent = formattedContent.replace(
                        item.placeholder, 
                        `<div class="code-block"><div class="code-header"><span>${lang}</span><button onclick="copyCode(this)"><i class="fas fa-copy"></i></button></div><pre><code class="language-${lang}">${escapeHtml(code)}</code></pre></div>`
                    );
                });
                
                inlineCodePlaceholders.forEach(item => {
                    formattedContent = formattedContent.replace(
                        item.placeholder,
                        `<code class="inline-code">${escapeHtml(item.content)}</code>`
                    );
                });

                if (websearchResults && websearchResults.quellen && Array.isArray(websearchResults.quellen)) {
                    const urlsHtml = websearchResults.quellen
                        .filter(url => url && typeof url === 'string' && url.startsWith('http'))
                        .map(url => `<a href="${url}" target="_blank" class="websearch-url">${url}</a>`)
                        .join('<br>');
                    if (urlsHtml) {
                        formattedContent += `<div class="websearch-results"><strong>${lang.web_search_results || 'Web Search Sources'}:</strong><br>${urlsHtml}</div>`;
                    }
                }

                if (deepsearchResults && deepsearchResults.quellen && Array.isArray(deepsearchResults.quellen)) {
                    const urlsHtml = deepsearchResults.quellen
                        .filter(url => url && typeof url === 'string' && url.startsWith('http'))
                        .map(url => `<a href="${url}" target="_blank" class="deepsearch-url">${url}</a>`)
                        .join('<br>');
                    if (urlsHtml) {
                        formattedContent += `<div class="deepsearch-results"><strong>${lang.deep_search_results || 'Deep Search Sources'}:</strong><br>${urlsHtml}</div>`;
                    }
                }

                if (codeExecutionResults) {
                    let parsedResults;
                    try {
                        parsedResults = typeof codeExecutionResults === 'string' ? JSON.parse(codeExecutionResults) : codeExecutionResults;
                    } catch (e) {
                        console.error('Error parsing code execution results:', e, codeExecutionResults);
                        return formattedContent;
                    }

                    if (!parsedResults || !parsedResults.code) {
                        console.warn('No valid code execution results:', parsedResults);
                        return formattedContent;
                    }

                    const packages = parsedResults.packages || [];
                    const packagesHtml = packages.length > 0 
                        ? `<div class="packages-list">${packages.map(pkg => `<span class="package-tag">${pkg}</span>`).join(' ')}</div>`
                        : `<span>${lang.none || 'None'}</span>`;

                    const status = parsedResults.status || (parsedResults.output ? 'success' : parsedResults.error ? 'error' : 'unknown');
                    const statusClass = status === 'success' ? 'status-success' : 'status-error';
                    const outputClass = status === 'success' ? 'execution-output' : 'execution-output execution-error';
                    const output = parsedResults.output || parsedResults.error || (lang.no_output || 'No output available');

                    formattedContent += `
                        <div class="codeexecution-results">
                            <div class="execution-header">
                                <div class="execution-title">
                                    <i class="fas fa-code"></i> ${lang.code_execution || 'Code Execution'}
                                </div>
                                <div class="execution-language">${parsedResults.language || lang.unknown || 'Unknown'}</div>
                            </div>
                            
                            <div class="execution-status ${statusClass}">
                                ${status.toUpperCase()}
                            </div>
                            
                            <div class="execution-info">
                                <div class="execution-info-item">
                                    <strong>${lang.language || 'Language'}:</strong>
                                    <span>${parsedResults.language || lang.unknown || 'Unknown'} ${parsedResults.version || ''}</span>
                                </div>
                                <div class="execution-info-item">
                                    <strong>${lang.internet || 'Internet'}:</strong>
                                    <span>${parsedResults.internet === 'true' ? lang.enabled || 'Enabled' : lang.disabled || 'Disabled'}</span>
                                </div>
                                <div class="execution-info-item">
                                    <strong>${lang.packages || 'Packages'}:</strong>
                                    ${packagesHtml}
                                </div>
                                ${parsedResults.description ? `<div class="execution-info-item"><strong>${lang.description || 'Description'}:</strong><span>${escapeHtml(parsedResults.description)}</span></div>` : ''}
                            </div>
                            
                            <div class="execution-code">
                                <div class="code-header"><span>${parsedResults.language || lang.code || 'Code'}</span><button onclick="copyCode(this)"><i class="fas fa-copy"></i></button></div>
                                <pre><code class="language-${parsedResults.language || 'text'}">${escapeHtml(parsedResults.code)}</code></pre>
                            </div>
                            
                            <div class="${outputClass}">
                                <div class="code-header"><span>${lang.output || 'Output'}</span><button onclick="copyCode(this)"><i class="fas fa-copy"></i></button></div>
                                <pre><code>${escapeHtml(output)}</code></pre>
                            </div>
                        </div>
                    `;
                }

                if (integrationResults) {
                    formattedContent += `
                        <div class="integration-results">
                            <div class="integration-header">
                                <i class="fas fa-plug"></i> ${lang.integrations || 'Integration'}: <strong>${integrationResults.integrationName || lang.unknown || 'Unknown'}</strong>
                            </div>
                            <div class="integration-details">
                                <p>${lang.integration_message || 'The integration has called external APIs to gather information.'}</p>
                                ${integrationResults.apiOutputs ? `
                                    <div class="integration-api-outputs">
                                        <strong>${lang.api_responses || 'API Responses'}:</strong>
                                        ${Object.keys(integrationResults.apiOutputs).map(key => `
                                            <div class="integration-api-output-item">
                                                <span>${key}:</span>
                                                <pre><code>${escapeHtml(JSON.stringify(integrationResults.apiOutputs[key], null, 2))}</code></pre>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                return formattedContent;
            }

            function addMessageToChat(message) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('chat-message', message.sender);
                messageElement.dataset.messageId = message.id;

                const iconHtml = message.sender === 'user' ? 'YOU' : '<img src="/icon.png" alt="AI Icon" width="32" height="32">';
                const infoHtml = message.sender === 'ai' && message.tokens !== undefined
                    ? `<div class="chat-message-info">⚡ ${message.tokens} ⌛ ${message.time}s</div>`
                    : '';

                const contentHtml = formatMessageContent(
                    message.content, 
                    message.websearchResults, 
                    message.deepsearchResults,
                    message.codeexecution_results || message.codeExecutionResults,
                    message.integrationResults
                );

                messageElement.innerHTML = `
                    <div class="icon">${iconHtml}</div>
                    <div class="chat-bubble-container">
                        <div class="chat-bubble">${contentHtml}</div>
                        ${infoHtml}
                    </div>`;
                
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function updateLastAiMessage(chunk, isDone = false, stats = {}, websearchResults = null, deepsearchResults = null, codeExecutionResults = null, integrationResults = null) {
                let lastMessageElement = chatMessages.querySelector('.chat-message.ai:last-child');
                
                if (!lastMessageElement) {
                    addMessageToChat({ id: `msg_${Date.now()}_ai`, sender: 'ai', content: '' });
                    lastMessageElement = chatMessages.querySelector('.chat-message.ai:last-child');
                }
                
                const bubble = lastMessageElement.querySelector('.chat-bubble');
                const currentContent = bubble.dataset.rawContent || '';
                const newContent = currentContent + chunk;
                bubble.dataset.rawContent = newContent;
                
                bubble.innerHTML = formatMessageContent(newContent, websearchResults, deepsearchResults, codeExecutionResults, integrationResults);

                if (isDone) {
                    const infoContainer = document.createElement('div');
                    infoContainer.classList.add('chat-message-info');
                    infoContainer.innerHTML = `⚡ ${stats.tokens} ⌛ ${stats.time}s`;
                    lastMessageElement.querySelector('.chat-bubble-container').appendChild(infoContainer);
                }
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function showLoadingIndicator(message) {
                loadingMessage.textContent = message;
                loadingIndicator.classList.add('active');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function hideLoadingIndicator() {
                loadingIndicator.classList.remove('active');
                loadingMessage.textContent = '';
            }

            function renderChatMessages(messages) {
                chatMessages.innerHTML = '';
                messages.forEach(msg => {
                    console.log('Rendering message:', msg.id, 'with codeexecution_results:', msg.codeexecution_results, 'integrationResults:', msg.integrationResults);
                    addMessageToChat(msg);
                });
                console.log('Finished rendering all messages');
            }

            async function sendMessage() {
                const content = messageInput.value.trim();
                if (!content || isGeneratingResponse) {
                    console.warn('SendMessage aborted: Either no content or generation is already running.');
                    return;
                }

                isGeneratingResponse = true;
                currentMessageId = `msg_${Date.now()}_ai`;
                sendMessageBtn.innerHTML = '<i class="fas fa-stop"></i>';
                messageInput.value = '';
                messageInput.disabled = false;

                addMessageToChat({ 
                    id: `msg_${Date.now()}_user`, 
                    sender: 'user', 
                    content 
                });

                let loadingMessageText = lang.ai_responding || 'AI is responding...';
                let apiUrl = '/api/chat/send';
                let requestBody = { message: content, model: modelSelector.value };

                if (activeFeature === 'Codeinterpreter') {
                    loadingMessageText = lang.code_running || 'Code is running...';
                    apiUrl = '/api/codeinterpreter';
                } else if (activeFeature === 'Websearch') {
                    loadingMessageText = lang.web_search_running || 'Web search is running...';
                    apiUrl = '/api/websearch';
                } else if (activeFeature === 'DeepSearch') {
                    loadingMessageText = lang.deep_search_running || 'Deep search is running...';
                    apiUrl = '/api/deepsearch';
                } else if (activeFeature === 'Integrations' && activeIntegrationId) {
                    loadingMessageText = `${lang.integrations || 'Integration'} "${activeIntegrationId}" ${lang.running || 'is running...'}`;
                    apiUrl = '/api/integrate';
                    requestBody.integrationId = activeIntegrationId;
                }
                
                showLoadingIndicator(loadingMessageText);

                try {
                    abortController = new AbortController();
                    let response;

                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error(lang.timeout_error || 'Request timeout after 10 minutes')), 600000)
                    );

                    response = await Promise.race([
                        authenticatedFetch(apiUrl, {
                            method: 'POST',
                            headers: { 'X-Chat-ID': currentChatId || '' },
                            body: JSON.stringify(requestBody),
                            signal: abortController.signal
                        }),
                        timeoutPromise
                    ]);

                    if (!response.ok) {
                        let errText = lang.error || 'Server error';
                        try {
                            const errJson = await response.json();
                            errText = errJson.details || errJson.message || JSON.stringify(errJson);
                        } catch {
                            try { errText = await response.text(); } catch (_) {}
                        }
                        throw new Error(errText);
                    }

                    const isStream = response.body && typeof response.body.getReader === 'function';

                    if (!isStream) {
                        let data;
                        try {
                            data = await response.json();
                        } catch (e) {
                            const text = await response.text().catch(() => '');
                            throw new Error(text || lang.invalid_response || 'Invalid server response.');
                        }

                        if (data && data.type === 'guard' && data.allowed === false) {
                            const lastUserMsg = chatMessages.querySelector('.chat-message.user:last-child .chat-bubble');
                            if (lastUserMsg) {
                                lastUserMsg.style.background = '#FF4444';
                                lastUserMsg.style.color = '#fff';
                                lastUserMsg.innerHTML += `<br><strong>${lang.inappropriate || 'Inappropriate!'}</strong>`;
                            }
                        } else if (data && data.type === 'error') {
                            throw new Error(data.details || data.message || lang.server_error || 'Server error');
                        } else {
                            if (data && data.message) {
                                showPopup(data.message, 'success');
                            }
                        }

                        isGeneratingResponse = false;
                        currentMessageId = null;
                        sendMessageBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                        messageInput.disabled = false;
                        messageInput.focus();
                        hideLoadingIndicator();
                        return;
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let aiResponseContent = '';
                    let streamEnded = false;
                    let websearchResults = null;
                    let deepsearchResults = null;
                    let codeExecutionResults = null;
                    let integrationResults = null;
                    let buffer = '';
                    
                    try {
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) {
                                streamEnded = true;
                                break;
                            }

                            const decodedChunk = decoder.decode(value, { stream: true });
                            buffer += decodedChunk;
                            const lines = buffer.split('\n');
                            buffer = lines.pop() || '';

                            for (const line of lines) {
                                const trimmedLine = line.trim();
                                if (!trimmedLine) continue;

                                let data;
                                try {
                                    data = JSON.parse(trimmedLine);
                                } catch (parseError) {
                                    console.warn('Could not parse stream line:', trimmedLine, parseError);
                                    continue;
                                }

                                if (data.type === 'progress') {
                                    showLoadingIndicator(data.message);
                                } else if (data.type === 'token') {
                                    aiResponseContent += data.token;
                                    updateLastAiMessage(data.token, false, {}, websearchResults, deepsearchResults, codeExecutionResults, integrationResults);
                                    hideLoadingIndicator();
                                } else if (data.type === 'websearch') {
                                    websearchResults = data.websearchResults;
                                    updateLastAiMessage('', false, {}, websearchResults, deepsearchResults, codeExecutionResults, integrationResults);
                                    hideLoadingIndicator();
                                } else if (data.type === 'deepsearch') {
                                    deepsearchResults = data.deepsearchResults;
                                    updateLastAiMessage('', false, {}, websearchResults, deepsearchResults, codeExecutionResults, integrationResults);
                                    hideLoadingIndicator();
                                } else if (data.type === 'codeexecution') {
                                    codeExecutionResults = data.codeExecutionResults;
                                    updateLastAiMessage('', false, {}, websearchResults, deepsearchResults, codeExecutionResults, integrationResults);
                                    hideLoadingIndicator();
                                } else if (data.type === 'integration') {
                                    integrationResults = data.integrationResults;
                                    updateLastAiMessage('', false, {}, websearchResults, deepsearchResults, codeExecutionResults, integrationResults);
                                    hideLoadingIndicator();
                                } else if (data.type === 'end') {
                                    updateLastAiMessage('', true, { tokens: data.tokens, time: data.time }, websearchResults, deepsearchResults, codeExecutionResults, integrationResults);
                                    if (data.isNewChat) currentChatId = data.chatId;
                                    loadChatList();
                                    loadUserInfo();
                                    streamEnded = true;
                                    if (activeFeature) {
                                        const buttonIdMap = {
                                            'Codeinterpreter': 'codeInterpreterBtn',
                                            'Websearch': 'websearchBtn',
                                            'DeepSearch': 'deepSearchBtn',
                                            'Integrations': 'integrationsMenuBtn'
                                        };
                                        document.getElementById(buttonIdMap[activeFeature])?.classList.remove('active');
                                        document.querySelector(`.integration-submenu-item[data-integration-id="${activeIntegrationId}"]`)?.classList.remove('active');
                                        showPopup(`${activeFeature} ${lang.disabled || 'disabled'}.`, 'info');
                                        activeFeature = null;
                                        activeIntegrationId = null;
                                    }
                                    hideLoadingIndicator();
                                    break;
                                } else if (data.type === 'error') {
                                    throw new Error(data.details || data.message || lang.error || 'Server error in stream');
                                }
                            }

                            if (streamEnded) break;
                        }
                    } catch (streamError) {
                        if (streamError.name !== 'AbortError' && streamError.message !== (lang.timeout_error || 'Request timeout after 10 minutes')) {
                            console.error('Stream error:', streamError);
                            updateLastAiMessage(`\n\n**${lang.error || 'Error'}:** ${streamError.message}`, false, {}, websearchResults, deepsearchResults, codeExecutionResults, integrationResults);
                        }
                    } finally {
                        reader.releaseLock();
                    }

                } catch (error) {
                    if (error.name !== 'AbortError' && error.message !== (lang.timeout_error || 'Request timeout after 10 minutes')) {
                        console.error('Error in AI response:', error);
                        updateLastAiMessage(`\n\n**${lang.error || 'Error'}:** ${error.message}`, false, {}, null, null, null, null);
                    }
                } finally {
                    isGeneratingResponse = false;
                    currentMessageId = null;
                    sendMessageBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                    messageInput.disabled = false;
                    messageInput.focus();
                    hideLoadingIndicator();
                }
            }

            sendMessageBtn.addEventListener('click', () => {
                if (isGeneratingResponse) {
                    stopGeneration();
                } else {
                    sendMessage();
                }
            });

            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (isGeneratingResponse) {
                        stopGeneration();
                    } else {
                        sendMessage();
                    }
                }
            });

            loadUserInfo();
            loadChatList();
            loadModels();
            loadIntegrationsUI();
        });
    </script>
</body>
</html>
