<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Tontoo AI | Admin</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="main-layout">
        <div class="sidebar">
            <div class="sidebar-header" style="text-align: center; margin-bottom: 30px; color: var(--text-farbe);">
                <img src="icon.png" alt="AI Icon" width="64" height="64">
                <h2>Admin Panel</h2>
            </div>
            <nav>
                <div class="admin-nav-item active" data-section="dashboard">
                    <i class="fas fa-chart-line"></i> <span>Dashboard</span>
                </div>
                <div class="admin-nav-item" data-section="users">
                    <i class="fas fa-users"></i> <span>Benutzer</span>
                </div>
                <div class="admin-nav-item" data-section="models">
                    <i class="fas fa-brain"></i> <span>Modelle</span>
                </div>
                <div class="admin-nav-item" data-section="config">
                    <i class="fas fa-cog"></i> <span>Konfiguration</span>
                </div>
                <div class="admin-nav-item" data-section="ollama">
                    <i class="fas fa-server"></i> <span>Ollama Server</span>
                </div>
            </nav>
        </div>

        <div class="content-area">
            <div class="admin-content">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="admin-section active">
                    <h2>Dashboard</h2>
                    <div class="dashboard-stats" style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div class="stat-card">
                            <h3>⚡ heute</h3>
                            <p id="tokensToday">Laden...</p>
                        </div>
                        <div class="stat-card">
                            <h3>⚡ gesamt</h3>
                            <p id="tokensOverall">Laden...</p>
                        </div>
                        <div class="stat-card">
                            <h3>CPU-Auslastung</h3>
                            <p id="cpuUsage">Laden...</p>
                        </div>
                        <div class="stat-card">
                            <h3>RAM-Nutzung</h3>
                            <p id="ramUsage">Laden...</p>
                        </div>
                    </div>
                </div>

                <!-- Users Section -->
                <div id="users-section" class="admin-section">
                    <div class="section-header">
                        <h2>Benutzerverwaltung</h2>
                        <button id="addUserBtn"><i class="fas fa-plus"></i> Neuer Benutzer</button>
                    </div>
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Benutzername</th>
                                <th>E-Mail</th>
                                <th>Name</th>
                                <th>Max ⚡</th>
                                <th>Genutzte ⚡</th>
                                <th>Admin</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                        </tbody>
                    </table>
                </div>

                <!-- Models Section -->
                <div id="models-section" class="admin-section">
                     <div class="section-header">
                        <h2>Modellverwaltung</h2>
                        <button id="addModelBtn"><i class="fas fa-plus"></i> Modell hinzufügen</button>
                    </div>
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID (Ollama)</th>
                                <th>Anzeigename</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="modelTableBody">
                        </tbody>
                    </table>
                </div>

                <!-- Config Section -->
                <div id="config-section" class="admin-section">
                    <div class="section-header">
                        <h2>System-Konfiguration</h2>
                        <button id="saveConfigBtn"><i class="fas fa-save"></i> Konfiguration speichern</button>
                    </div>
                    <div id="configForm">
                        <div class="config-group">
                            <h3><i class="fas fa-network-wired"></i> Server-Einstellungen</h3>
                            <div class="form-group">
                                <label for="mainPort">Haupt-Port (HTTP)</label>
                                <input type="number" id="mainPort" name="main-port">
                            </div>
                            <div class="form-group">
                                <label for="sslPort">SSL-Port (HTTPS)</label>
                                <input type="number" id="sslPort" name="ssl-port">
                            </div>
                            <div class="form-group">
                                <label for="hostName">Host</label>
                                <input type="text" id="hostName" name="host">
                            </div>
                            <div class="form-group">
                                <label for="trustedDomains">Vertrauenswürdige Domains (durch Komma getrennt)</label>
                                <input type="text" id="trustedDomains" name="trusted-domains">
                            </div>
                        </div>

                        <div class="config-group">
                            <h3><i class="fas fa-robot"></i> Ollama-Einstellungen</h3>
                            <div class="form-group">
                                <label for="ollamaPort">Ollama Port</label>
                                <input type="number" id="ollamaPort" name="ollama-port">
                            </div>
                            <div class="form-group">
                                <label for="ollamaHost1">Ollama Host 1</label>
                                <input type="text" id="ollamaHost1" name="ollama-host1">
                            </div>
                            <div class="form-group">
                                <label for="ollamaHost2">Ollama Host 2</label>
                                <input type="text" id="ollamaHost2" name="ollama-host2">
                            </div>
                        </div>

                        <div class="config-group">
                            <h3><i class="fas fa-envelope"></i> E-Mail-Einstellungen</h3>
                            <div class="form-group admin-checkbox">
                                <label for="smtpEnabled">E-Mail-Funktionen aktivieren</label>
                                <input type="checkbox" id="smtpEnabled" name="smtp-enabled">
                            </div>
                            <div class="form-group">
                                <label for="smtpHost">SMTP Host</label>
                                <input type="text" id="smtpHost" name="smtp-host">
                            </div>
                            <div class="form-group">
                                <label for="smtpPort">SMTP Port</label>
                                <input type="number" id="smtpPort" name="smtp-port">
                            </div>
                            <div class="form-group admin-checkbox">
                                <label for="smtpSecure">Sichere Verbindung (SSL/TLS)</label>
                                <input type="checkbox" id="smtpSecure" name="smtp-secure">
                            </div>
                            <div class="form-group">
                                <label for="smtpUser">SMTP Benutzername</label>
                                <input type="text" id="smtpUser" name="smtp-user">
                            </div>
                            <div class="form-group">
                                <label for="smtpPass">SMTP Passwort</label>
                                <input type="password" id="smtpPass" name="smtp-pass">
                            </div>
                        </div>

                        <div class="config-group">
                            <h3><i class="fas fa-language"></i> KI-Einstellungen</h3>
                            <div class="form-group">
                                <label for="configLanguage">Sprache</label>
                                <input type="text" id="configLanguage" name="sprache">
                            </div>
                            <div class="form-group">
                                <label for="systemPrompt">System-Prompt</label>
                                <textarea id="systemPrompt" name="system-prompt" rows="6"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ollama Management Section -->
                <div id="ollama-section" class="admin-section">
                    <div class="section-header">
                        <h2>Ollama Server Verwaltung</h2>
                        <div>
                            <button id="pullModelBtn"><i class="fas fa-download"></i> Modell herunterladen</button>
                            <button id="removeModelBtn" class="danger"><i class="fas fa-trash"></i> Modell entfernen</button>
                        </div>
                    </div>
                    <div class="ollama-status">
                        <h3>Server Status</h3>
                        <div id="ollamaServerStatus" style="display: flex; gap: 20px; margin: 20px 0;">
                            <div class="status-card">
                                <h4>Host 1 (<span id="host1Name">localhost</span>)</h4>
                                <p id="host1Status">Prüfe...</p>
                            </div>
                            <div class="status-card">
                                <h4>Host 2 (<span id="host2Name">none</span>)</h4>
                                <p id="host2Status">Deaktiviert</p>
                            </div>
                        </div>
                    </div>
                    <div id="ollamaResults" style="margin-top: 20px;"></div>
                </div>
            </div>

            <div class="user-info-footer" id="userInfoFooter">
                <i class="fas fa-user icon"></i>
                <span id="userTokensSummary"></span>
                <div class="user-info-popup" id="userInfoPopup">
                    <p>⚡ genutzt: <span id="popupUsedTokens"></span></p>
                    <p>⚡ Max: <span id="popupMaxTokens"></span></p>
                    <button onclick="window.location.href='/settings.html'"><i class="fas fa-cog"></i> Einstellungen</button>
                    <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Abmelden</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Existing Modals -->
    <div id="userModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-button">&times;</button>
            <h3 id="userModalTitle">Benutzer erstellen</h3>
            <form id="userForm">
                <input type="hidden" id="userId" name="id">
                <div class="form-group"><label for="modalUsername">Benutzername</label><input type="text" id="modalUsername" name="username" required></div>
                <div class="form-group"><label for="modalEmail">E-Mail</label><input type="email" id="modalEmail" name="email" required></div>
                <div class="form-group"><label for="modalPassword">Passwort (leer lassen zum Beibehalten)</label><input type="password" id="modalPassword" name="password"></div>
                <div class="form-group"><label for="modalFirstName">Vorname</label><input type="text" id="modalFirstName" name="firstName" required></div>
                <div class="form-group"><label for="modalMaxTokens">Max ⚡ ( -- für unendlich)</label><input type="text" id="modalMaxTokens" name="max-tokens" value="--"></div>
                <div class="form-group admin-checkbox"><label for="modalAdmin">Admin</label><input type="checkbox" id="modalAdmin" name="admin"></div>
                <div class="form-group"><label for="modalPersonalPrompt">Persönlicher KI-Prompt</label><textarea id="modalPersonalPrompt" name="personal-ai-prompt" rows="3"></textarea></div>
                <div class="form-group"><label for="modalLocation">Standort</label><input type="text" id="modalLocation" name="location"></div>
                <button type="submit" id="userFormSubmitBtn">Erstellen</button>
            </form>
        </div>
    </div>

    <div id="modelModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-button">&times;</button>
            <h3>Modell hinzufügen</h3>
            <form id="modelForm">
                <div class="form-group"><label for="ollamaModelId">Ollama Modell ID (z.B. llama3:8b)</label><input type="text" id="ollamaModelId" name="ollamaModelId" required></div>
                <div class="form-group"><label for="displayName">Anzeigename</label><input type="text" id="displayName" name="displayName" required></div>
                <button type="submit">Hinzufügen</button>
            </form>
        </div>
    </div>

    <!-- New Ollama Model Management Modal -->
    <div id="ollamaModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-button">&times;</button>
            <h3 id="ollamaModalTitle">Modell verwalten</h3>
            <form id="ollamaForm">
                <div class="form-group">
                    <label for="ollamaModelManage">Modell ID (z.B. llama3:8b, mistral, gemma:7b)</label>
                    <input type="text" id="ollamaModelManage" name="modelId" required>
                </div>
                <input type="hidden" id="ollamaAction" name="action">
                <button type="submit" id="ollamaFormSubmitBtn">Herunterladen</button>
            </form>
        </div>
    </div>

    <div id="popupContainer"></div>

    <script>
        // Global functions for dynamic buttons
        window.editUser = async function(userId) {
            try {
                const response = await authenticatedFetch(`/api/admin/users/${userId}`);
                if (!response.ok) throw new Error('Benutzerdaten konnten nicht geladen werden.');
                const user = await response.json();
                openModal('userModal', true, user);
            } catch (error) {
                console.error('Fehler beim Laden der Benutzerdaten zum Bearbeiten:', error);
                showPopup('Fehler beim Laden der Benutzerdaten zum Bearbeiten.', 'error');
            }
        }

        window.deleteUser = async function(userId) {
            if (!confirm('Sind Sie sicher, dass Sie diesen Benutzer löschen möchten?')) return;
            try {
                const response = await authenticatedFetch(`/api/admin/users/${userId}`, { method: 'DELETE' });
                if (response.ok) {
                    showPopup('Benutzer erfolgreich gelöscht.', 'success');
                    loadUsers();
                } else {
                    const data = await response.json();
                    showPopup(data.message || 'Fehler beim Löschen des Benutzers.', 'error');
                }
            } catch (error) {
                console.error('Fehler beim Löschen des Benutzers:', error);
                showPopup('Ein unerwarteter Fehler ist aufgetreten.', 'error');
            }
        }

        window.deleteModel = async function(modelId) {
            const decodedModelId = decodeURIComponent(modelId);
            if (!confirm(`Sind Sie sicher, dass Sie das Modell "${decodedModelId}" löschen möchten?`)) return;
            try {
                const response = await authenticatedFetch(`/api/admin/models/${encodeURIComponent(decodedModelId)}`, { method: 'DELETE' });
                if (response.ok) {
                    showPopup('Modell erfolgreich gelöscht.', 'success');
                    loadModels();
                } else {
                    const data = await response.json();
                    showPopup(data.message || 'Fehler beim Löschen des Modells.', 'error');
                }
            } catch (error) {
                console.error('Fehler beim Löschen des Modells:', error);
                showPopup('Ein unerwarteter Fehler ist aufgetreten.', 'error');
            }
        }

        // Utility functions
        async function authenticatedFetch(url, options = {}) {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                ...options.headers
            };
            const response = await fetch(url, { ...options, headers });
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('authToken');
                window.location.href = '/login.html';
                throw new Error('Nicht authentifiziert oder nicht autorisiert.');
            }
            return response;
        }

        const popupContainer = document.getElementById('popupContainer');
        function showPopup(message, type = 'error') {
            const popup = document.createElement('div');
            popup.classList.add('popup', type);
            popup.textContent = message;
            popupContainer.appendChild(popup);
            setTimeout(() => popup.remove(), 5000);
        }

        function openModal(modalId, isEdit = false, data = {}) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';

            if (modalId === 'userModal') {
                const form = document.getElementById('userForm');
                form.reset();
                document.getElementById('userModalTitle').textContent = isEdit ? 'Benutzer bearbeiten' : 'Benutzer erstellen';
                document.getElementById('userFormSubmitBtn').textContent = isEdit ? 'Änderungen speichern' : 'Erstellen';
                
                if (isEdit) {
                    document.getElementById('userId').value = data.id;
                    document.getElementById('modalUsername').value = data.username;
                    document.getElementById('modalEmail').value = data.email;
                    document.getElementById('modalFirstName').value = data.firstName;
                    document.getElementById('modalMaxTokens').value = data['max-tokens'];
                    document.getElementById('modalAdmin').checked = data.admin;
                    document.getElementById('modalPersonalPrompt').value = data.profile['personal-ai-prompt'] || '';
                    document.getElementById('modalLocation').value = data.profile.location || '';
                    document.getElementById('modalPassword').removeAttribute('required');
                } else {
                    document.getElementById('userId').value = '';
                    document.getElementById('modalPassword').setAttribute('required', 'required');
                }
            } else if (modalId === 'modelModal') {
                 document.getElementById('modelForm').reset();
            } else if (modalId === 'ollamaModal') {
                document.getElementById('ollamaForm').reset();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            // General initialization
            (async () => {
                try {
                    const response = await fetch('/api/general-config');
                    const config = await response.json();
                    document.getElementById('pageTitle').textContent = config['html-titel'].replace('%name', 'Admin');
                } catch (error) {
                    console.error('Fehler beim Laden der allgemeinen Konfiguration:', error);
                }
            })();

            // Authentication and user info
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            async function loadUserInfo() {
                try {
                    const response = await authenticatedFetch('/api/user/me');
                    if (!response.ok) throw new Error('Benutzerdaten konnten nicht geladen werden.');
                    const userData = await response.json();
                    if (!userData.admin) {
                         window.location.href = '/chat.html';
                         return;
                    }
                    const usedTokens = userData['used-tokens'] || 0;
                    const maxTokens = userData['max-tokens'] === '--' ? '∞' : userData['max-tokens'];
                    document.getElementById('userTokensSummary').textContent = `${usedTokens} / ${maxTokens} ⚡`;
                    document.getElementById('popupUsedTokens').textContent = usedTokens;
                    document.getElementById('popupMaxTokens').textContent = maxTokens;
                } catch (error) {
                    console.error('Fehler beim Laden der Benutzerinfo:', error);
                }
            }

            function logout() {
                authenticatedFetch('/api/logout', { method: 'POST' })
                    .then(() => {
                        localStorage.removeItem('authToken');
                        window.location.href = '/login.html';
                    })
                    .catch(error => {
                        console.error('Logout fehlgeschlagen:', error);
                        showPopup('Logout fehlgeschlagen.', 'error');
                    });
            }
            document.getElementById('logoutBtn').addEventListener('click', logout);

            // UI Interactions
            const navItems = document.querySelectorAll('.admin-nav-item');
            const sections = document.querySelectorAll('.admin-section');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    if (item.dataset.section) {
                        navItems.forEach(nav => nav.classList.remove('active'));
                        item.classList.add('active');
                        sections.forEach(section => section.classList.remove('active'));
                        document.getElementById(`${item.dataset.section}-section`).classList.add('active');
                        
                        switch (item.dataset.section) {
                            case 'dashboard': loadDashboardData(); break;
                            case 'users': loadUsers(); break;
                            case 'models': loadModels(); break;
                            case 'config': loadConfig(); break;
                            case 'ollama': loadOllamaStatus(); break;
                        }
                    }
                });
            });
            
            document.querySelectorAll('.modal-overlay .close-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    closeModal(btn.closest('.modal-overlay').id);
                });
            });

            // Button event listeners
            document.getElementById('addUserBtn').addEventListener('click', () => openModal('userModal'));
            document.getElementById('addModelBtn').addEventListener('click', () => openModal('modelModal'));
            document.getElementById('saveConfigBtn').addEventListener('click', saveConfig);
            document.getElementById('pullModelBtn').addEventListener('click', () => {
                document.getElementById('ollamaAction').value = 'pull';
                document.getElementById('ollamaModalTitle').textContent = 'Modell herunterladen';
                document.getElementById('ollamaFormSubmitBtn').textContent = 'Herunterladen';
                openModal('ollamaModal');
            });
            document.getElementById('removeModelBtn').addEventListener('click', () => {
                document.getElementById('ollamaAction').value = 'remove';
                document.getElementById('ollamaModalTitle').textContent = 'Modell entfernen';
                document.getElementById('ollamaFormSubmitBtn').textContent = 'Entfernen';
                document.getElementById('ollamaFormSubmitBtn').className = 'danger';
                openModal('ollamaModal');
            });
            
            const userInfoFooter = document.getElementById('userInfoFooter');
            const userInfoPopup = document.getElementById('userInfoPopup');
            userInfoFooter.addEventListener('click', (event) => {
                if (!userInfoPopup.contains(event.target)) {
                    userInfoPopup.classList.toggle('active');
                }
            });
            document.addEventListener('click', (event) => {
                if (!userInfoFooter.contains(event.target)) {
                    userInfoPopup.classList.remove('active');
                }
            });

            // Data loading functions
            async function loadDashboardData() {
                try {
                    const response = await authenticatedFetch('/api/admin/stats');
                    if (!response.ok) throw new Error('Statistiken konnten nicht geladen werden.');
                    const stats = await response.json();
                    const today = new Date().toISOString().slice(0, 10);
                    document.getElementById('tokensToday').textContent = stats.dailyStats[today]?.totalTokensUsed || 0;
                    document.getElementById('tokensOverall').textContent = stats.overallStats.totalTokensUsed || 0;
                    document.getElementById('cpuUsage').textContent = `${(stats.overallStats.cpuUsageAvg * 100).toFixed(2)}%`;
                    document.getElementById('ramUsage').textContent = `${(stats.overallStats.ramUsageAvg * 100).toFixed(2)}%`;
                } catch (error) {
                    console.error('Fehler beim Laden der Dashboard-Daten:', error);
                    showPopup('Fehler beim Laden der Dashboard-Daten.', 'error');
                }
            }

            async function loadUsers() {
                try {
                    const response = await authenticatedFetch('/api/admin/users');
                    if (!response.ok) throw new Error('Benutzer konnten nicht geladen werden.');
                    const users = await response.json();
                    const tableBody = document.getElementById('userTableBody');
                    tableBody.innerHTML = '';
                    users.forEach(user => {
                        const row = tableBody.insertRow();
                        row.innerHTML = `
                            <td>${user.id}</td>
                            <td>${user.username}</td>
                            <td>${user.email}</td>
                            <td>${user.firstName}</td>
                            <td>${user['max-tokens']}</td>
                            <td>${user['used-tokens']}</td>
                            <td>${user.admin ? '<i class="fas fa-check-circle" style="color: var(--erfolgs-farbe);"></i>' : '<i class="fas fa-times-circle" style="color: var(--fehler-farbe);"></i>'}</td>
                            <td class="actions">
                                <button onclick="editUser(${user.id})"><i class="fas fa-edit"></i></button>
                                <button class="danger" onclick="deleteUser(${user.id})"><i class="fas fa-trash"></i></button>
                            </td>
                        `;
                    });
                } catch (error) {
                    console.error('Fehler beim Laden der Benutzer:', error);
                    showPopup('Fehler beim Laden der Benutzerdaten.', 'error');
                }
            }

            async function loadModels() {
                try {
                    const response = await authenticatedFetch('/api/admin/models');
                    if (!response.ok) throw new Error('Modelle konnten nicht geladen werden.');
                    const models = await response.json();
                    const tableBody = document.getElementById('modelTableBody');
                    tableBody.innerHTML = '';
                    for (const modelId in models) {
                        const row = tableBody.insertRow();
                        const encodedModelId = encodeURIComponent(modelId);
                        row.innerHTML = `
                            <td>${modelId}</td>
                            <td>${models[modelId]}</td>
                            <td class="actions">
                                <button class="danger" onclick="deleteModel('${encodedModelId}')"><i class="fas fa-trash"></i></button>
                            </td>
                        `;
                    }
                } catch (error) {
                    console.error('Fehler beim Laden der Modelle:', error);
                    showPopup('Fehler beim Laden der Modelle.', 'error');
                }
            }

            async function loadConfig() {
                try {
                    const response = await authenticatedFetch('/api/admin/config');
                    if (!response.ok) throw new Error('Konfiguration konnte nicht geladen werden.');
                    const config = await response.json();
                    
                    // Server settings
                    document.getElementById('mainPort').value = config['main-port'];
                    document.getElementById('sslPort').value = config['ssl-port'];
                    document.getElementById('hostName').value = config.host;
                    document.getElementById('trustedDomains').value = config['trusted-domains'].join(', ');
                    
                    // Ollama settings
                    document.getElementById('ollamaPort').value = config.ollama.port;
                    document.getElementById('ollamaHost1').value = config.ollama.host1;
                    document.getElementById('ollamaHost2').value = config.ollama.host2;
                    
                    // SMTP settings
                    document.getElementById('smtpEnabled').checked = config.smtp?.enabled !== false;
                    document.getElementById('smtpHost').value = config.smtp?.host || '';
                    document.getElementById('smtpPort').value = config.smtp?.port || '';
                    document.getElementById('smtpSecure').checked = config.smtp?.secure || false;
                    document.getElementById('smtpUser').value = config.smtp?.auth?.user || '';
                    document.getElementById('smtpPass').value = config.smtp?.auth?.pass || '';
                    
                    // AI settings
                    document.getElementById('configLanguage').value = config.sprache;
                    document.getElementById('systemPrompt').value = config['system-prompt'];
                    
                } catch (error) {
                    console.error('Fehler beim Laden der Konfiguration:', error);
                    showPopup('Fehler beim Laden der Konfiguration.', 'error');
                }
            }

            async function saveConfig() {
                try {
                    const updatedConfig = {
                        'main-port': parseInt(document.getElementById('mainPort').value),
                        'ssl-port': parseInt(document.getElementById('sslPort').value),
                        'host': document.getElementById('hostName').value,
                        'trusted-domains': document.getElementById('trustedDomains').value.split(',').map(d => d.trim()),
                        'ollama': {
                            'port': parseInt(document.getElementById('ollamaPort').value),
                            'host1': document.getElementById('ollamaHost1').value,
                            'host2': document.getElementById('ollamaHost2').value
                        },
                        'smtp': {
                            'enabled': document.getElementById('smtpEnabled').checked,
                            'host': document.getElementById('smtpHost').value,
                            'port': parseInt(document.getElementById('smtpPort').value),
                            'secure': document.getElementById('smtpSecure').checked,
                            'auth': {
                                'user': document.getElementById('smtpUser').value,
                                'pass': document.getElementById('smtpPass').value
                            }
                        },
                        'sprache': document.getElementById('configLanguage').value,
                        'system-prompt': document.getElementById('systemPrompt').value
                    };

                    const response = await authenticatedFetch('/api/admin/config', {
                        method: 'PUT',
                        body: JSON.stringify({ updatedConfig })
                    });

                    if (response.ok) {
                        showPopup('Konfiguration erfolgreich gespeichert. Server-Neustart empfohlen.', 'success');
                    } else {
                        const data = await response.json();
                        showPopup(data.message || 'Fehler beim Speichern der Konfiguration.', 'error');
                    }
                } catch (error) {
                    console.error('Fehler beim Speichern der Konfiguration:', error);
                    showPopup('Ein unerwarteter Fehler ist aufgetreten.', 'error');
                }
            }

            async function loadOllamaStatus() {
                try {
                    const configResponse = await authenticatedFetch('/api/admin/config');
                    const config = await configResponse.json();
                    
                    document.getElementById('host1Name').textContent = config.ollama.host1;
                    document.getElementById('host2Name').textContent = config.ollama.host2;
                    
                    // Check host1 status
                    try {
                        const host1 = config.ollama.host1 === 'localhost' ? '127.0.0.1' : config.ollama.host1;
                        const host1Response = await fetch(`http://${host1}:${config.ollama.port}/api/version`);
                        if (host1Response.ok) {
                            const version = await host1Response.json();
                            document.getElementById('host1Status').innerHTML = `<span style="color: var(--erfolgs-farbe);">Online (v${version.version || 'unknown'})</span>`;
                        } else {
                            document.getElementById('host1Status').innerHTML = `<span style="color: var(--fehler-farbe);">Offline</span>`;
                        }
                    } catch (error) {
                        document.getElementById('host1Status').innerHTML = `<span style="color: var(--fehler-farbe);">Offline</span>`;
                    }
                    
                    // Check host2 status if enabled
                    if (config.ollama.host2 !== 'none') {
                        try {
                            const host2 = config.ollama.host2 === 'localhost' ? '127.0.0.1' : config.ollama.host2;
                            const host2Response = await fetch(`http://${host2}:${config.ollama.port}/api/version`);
                            if (host2Response.ok) {
                                const version = await host2Response.json();
                                document.getElementById('host2Status').innerHTML = `<span style="color: var(--erfolgs-farbe);">Online (v${version.version || 'unknown'})</span>`;
                            } else {
                                document.getElementById('host2Status').innerHTML = `<span style="color: var(--fehler-farbe);">Offline</span>`;
                            }
                        } catch (error) {
                            document.getElementById('host2Status').innerHTML = `<span style="color: var(--fehler-farbe);">Offline</span>`;
                        }
                    } else {
                        document.getElementById('host2Status').innerHTML = `<span style="color: var(--text-farbe-gedaempft);">Deaktiviert</span>`;
                    }
                } catch (error) {
                    console.error('Fehler beim Laden des Ollama-Status:', error);
                    showPopup('Fehler beim Laden des Ollama-Status.', 'error');
                }
            }

            // Form handlers
            document.getElementById('userForm').addEventListener('submit', async (event) => {
                event.preventDefault();
                const userId = document.getElementById('userId').value;
                const isEdit = !!userId;
                const formData = new FormData(event.target);
                const userData = Object.fromEntries(formData.entries());
                userData.admin = document.getElementById('modalAdmin').checked;
                if (isEdit && userData.password === '') delete userData.password;
                
                userData.profile = {
                    'personal-ai-prompt': userData['personal-ai-prompt'],
                    'location': userData.location
                };
                delete userData['personal-ai-prompt'];
                delete userData.location;

                try {
                    const url = isEdit ? `/api/admin/users/${userId}` : '/api/admin/users';
                    const method = isEdit ? 'PUT' : 'POST';
                    const response = await authenticatedFetch(url, { method, body: JSON.stringify(userData) });
                    const data = await response.json();
                    if (response.ok) {
                        showPopup(`Benutzer erfolgreich ${isEdit ? 'aktualisiert' : 'erstellt'}.`, 'success');
                        closeModal('userModal');
                        loadUsers();
                    } else {
                        showPopup(data.message || 'Fehler beim Speichern des Benutzers.', 'error');
                    }
                } catch (error) {
                    console.error('Fehler beim Speichern des Benutzers:', error);
                    showPopup('Ein unerwarteter Fehler ist aufgetreten.', 'error');
                }
            });

            document.getElementById('modelForm').addEventListener('submit', async (event) => {
                event.preventDefault();
                const ollamaModelId = document.getElementById('ollamaModelId').value;
                const displayName = document.getElementById('displayName').value;
                try {
                    const response = await authenticatedFetch('/api/admin/models', {
                        method: 'POST',
                        body: JSON.stringify({ ollamaModelId, displayName })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showPopup('Modell erfolgreich hinzugefügt.', 'success');
                        closeModal('modelModal');
                        loadModels();
                    } else {
                        showPopup(data.message || 'Fehler beim Hinzufügen des Modells.', 'error');
                    }
                } catch (error) {
                    console.error('Fehler beim Hinzufügen des Modells:', error);
                    showPopup('Ein unerwarteter Fehler ist aufgetreten.', 'error');
                }
            });

            document.getElementById('ollamaForm').addEventListener('submit', async (event) => {
                event.preventDefault();
                const modelId = document.getElementById('ollamaModelManage').value;
                const action = document.getElementById('ollamaAction').value;
                
                try {
                    showPopup(`${action === 'pull' ? 'Download' : 'Entfernung'} gestartet. Dies kann einige Minuten dauern...`, 'info');
                    
                    const response = await authenticatedFetch('/api/admin/models/manage', {
                        method: 'POST',
                        body: JSON.stringify({ action, modelId })
                    });
                    
                    const data = await response.json();
                    if (response.ok) {
                        const resultsDiv = document.getElementById('ollamaResults');
                        resultsDiv.innerHTML = '<h4>Ergebnisse:</h4>';
                        data.results.forEach(result => {
                            const div = document.createElement('div');
                            div.className = `result-item ${result.success ? 'success' : 'error'}`;
                            div.innerHTML = `<strong>${result.host}:</strong> ${result.message}`;
                            resultsDiv.appendChild(div);
                        });
                        
                        const successCount = data.results.filter(r => r.success).length;
                        if (successCount > 0) {
                            showPopup(`${action === 'pull' ? 'Download' : 'Entfernung'} auf ${successCount} Server(n) erfolgreich.`, 'success');
                        } else {
                            showPopup(`${action === 'pull' ? 'Download' : 'Entfernung'} auf allen Servern fehlgeschlagen.`, 'error');
                        }
                        
                        closeModal('ollamaModal');
                        if (action === 'remove') loadModels(); // Refresh models list if removed
                    } else {
                        showPopup(data.message || 'Fehler bei der Modellverwaltung.', 'error');
                    }
                } catch (error) {
                    console.error('Fehler bei der Ollama-Modellverwaltung:', error);
                    showPopup('Ein unerwarteter Fehler ist aufgetreten.', 'error');
                }
            });

            // Initial load
            loadUserInfo();
            loadDashboardData();
        });
    </script>
</body>
</html>
