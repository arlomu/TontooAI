<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Tontoo AI | Passwort zurücksetzen</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <h1>Passwort zurücksetzen</h1>
        
        <div id="requestResetSection">
            <p>Geben Sie Ihre E-Mail-Adresse ein, um einen Link zum Zurücksetzen des Passworts zu erhalten.</p>
            <form id="passwordResetRequestForm">
                <div class="form-group">
                    <label for="email">E-Mail-Adresse</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <button type="submit">Link senden</button>
            </form>
        </div>

        <div id="resetPasswordSection" style="display: none;">
            <p>Bitte geben Sie Ihr neues Passwort ein.</p>
            <form id="passwordResetForm">
                <input type="hidden" id="resetToken" name="token">
                <div class="form-group">
                    <label for="newPassword">Neues Passwort</label>
                    <input type="password" id="newPassword" name="newPassword" required minlength="6">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Passwort bestätigen</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required minlength="6">
                </div>
                <button type="submit">Passwort ändern</button>
            </form>
        </div>

        <p style="margin-top: 20px;"><a href="/login.html" style="color: var(--sekundaer-text-farbe);">Zurück zum Login</a></p>
    </div>

    <div id="popupContainer"></div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/api/general-config');
                const config = await response.json();
                document.getElementById('pageTitle').textContent = config['html-titel'].replace('%name', 'Passwort zurücksetzen');
            } catch (error) {
                console.error('Fehler beim Laden der allgemeinen Konfiguration:', error);
            }

            const urlParams = new URLSearchParams(window.location.search);
            const resetToken = urlParams.get('token');
            
            const requestResetSection = document.getElementById('requestResetSection');
            const resetPasswordSection = document.getElementById('resetPasswordSection');
            const passwordResetRequestForm = document.getElementById('passwordResetRequestForm');
            const passwordResetForm = document.getElementById('passwordResetForm');
            const popupContainer = document.getElementById('popupContainer');

            // Prüfen ob Reset-Token in der URL ist
            if (resetToken) {
                requestResetSection.style.display = 'none';
                resetPasswordSection.style.display = 'block';
                document.getElementById('resetToken').value = resetToken;
            }

            function showPopup(message, type = 'error') {
                const popup = document.createElement('div');
                popup.classList.add('popup', type);
                popup.textContent = message;
                popupContainer.appendChild(popup);

                setTimeout(() => {
                    popup.remove();
                }, 5000);
            }

            // Formular zum Anfordern des Reset-Links
            passwordResetRequestForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const email = document.getElementById('email').value;

                try {
                    const response = await fetch('/api/request-password-reset', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showPopup('Wenn die E-Mail-Adresse registriert ist, erhalten Sie in Kürze einen Link zum Zurücksetzen des Passworts.', 'success');
                        passwordResetRequestForm.reset();
                    } else {
                        showPopup(data.message || 'Fehler beim Anfordern des Reset-Links.', 'error');
                    }
                } catch (error) {
                    console.error('Fehler beim Anfordern des Reset-Links:', error);
                    showPopup('Ein unerwarteter Fehler ist aufgetreten.', 'error');
                }
            });

            // Formular zum tatsächlichen Zurücksetzen des Passworts
            passwordResetForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                
                const token = document.getElementById('resetToken').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                // Passwörter vergleichen
                if (newPassword !== confirmPassword) {
                    showPopup('Die Passwörter stimmen nicht überein.', 'error');
                    return;
                }

                // Passwortlänge prüfen
                if (newPassword.length < 6) {
                    showPopup('Das Passwort muss mindestens 6 Zeichen lang sein.', 'error');
                    return;
                }

                try {
                    const response = await fetch('/api/reset-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ token, newPassword })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showPopup('Ihr Passwort wurde erfolgreich geändert. Sie können sich jetzt mit dem neuen Passwort anmelden.', 'success');
                        // Zur Login-Seite umleiten nach kurzer Zeit
                        setTimeout(() => {
                            window.location.href = '/login.html';
                        }, 3000);
                    } else {
                        showPopup(data.message || 'Fehler beim Zurücksetzen des Passworts.', 'error');
                    }
                } catch (error) {
                    console.error('Fehler beim Zurücksetzen des Passworts:', error);
                    showPopup('Ein unerwarteter Fehler ist aufgetreten.', 'error');
                }
            });
        });
    </script>
</body>
</html>