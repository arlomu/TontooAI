<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Tontoo AI | Einstellungen</title>
    <link rel="stylesheet" href="/style.css">
    <!-- FontAwesome für Icons, wenn verwendet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="main-layout">
        <div class="content-area">
            <div class="admin-content">
                <button onclick="window.history.back()" style="margin-bottom: 20px;"><i class="fas fa-arrow-left"></i> Zurück</button>
                <h2>Einstellungen</h2>

                <div class="settings-section">
                    <h3 id="personalInfoTitle"></h3>
                    <form id="personalInfoForm">
                        <div class="form-group">
                            <label for="firstName" id="firstNameLabel"></label>
                            <input type="text" id="firstName" name="firstName">
                        </div>
                        <div class="form-group">
                            <label for="location" id="locationLabel"></label>
                            <input type="text" id="location" name="location">
                        </div>
                        <div class="form-group">
                            <label for="personalPrompt" id="personalPromptLabel"></label>
                            <textarea id="personalPrompt" name="personalPrompt" rows="5"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="panelLanguage" id="panelLanguageLabel"></label>
                            <select id="panelLanguage" name="panelLanguage">
                                <option value="EN"></option>
                                <option value="DE"></option>
                            </select>
                        </div>
                        <button type="submit" id="savePersonalBtn" style="float: right;"></button>
                        <div style="clear: both;"></div>
                    </form>
                </div>

                <div class="settings-section" style="margin-top: 40px;">
                    <h3 id="changePasswordTitle"></h3>
                    <form id="passwordChangeForm">
                        <div class="form-group">
                            <label for="currentPassword" id="currentPasswordLabel"></label>
                            <input type="password" id="currentPassword" name="currentPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword" id="newPasswordLabel"></label>
                            <input type="password" id="newPassword" name="newPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="confirmNewPassword" id="confirmNewPasswordLabel"></label>
                            <input type="password" id="confirmNewPassword" name="confirmNewPassword" required>
                        </div>
                        <button type="submit" id="savePasswordBtn" style="float: right;"></button>
                        <div style="clear: both;"></div>
                    </form>
                </div>

                <div class="settings-section" style="margin-top: 40px;">
                    <h3 id="changeEmailTitle"></h3>
                    <form id="emailChangeForm">
                        <div class="form-group">
                            <label for="newEmail" id="newEmailLabel"></label>
                            <input type="email" id="newEmail" name="newEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="emailConfirmPassword" id="emailConfirmPasswordLabel"></label>
                            <input type="password" id="emailConfirmPassword" name="emailConfirmPassword" required>
                        </div>
                        <button type="submit" id="saveEmailBtn" style="float: right;"></button>
                        <div style="clear: both;"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="popupContainer"></div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- Language Helper ---
            let lang = {};
            let userLang = 'EN';

            async function loadLangFile(langCode) {
                const res = await fetch(`/Lang_${langCode}.json`);
                lang = await res.json();
            }

            // Load user language from backend or fallback to EN
            async function getUserLanguage() {
                try {
                    const token = localStorage.getItem('authToken');
                    if (!token) return 'EN';
                    const res = await fetch('/api/user/me', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!res.ok) return 'EN';
                    const user = await res.json();
                    return user.panelLanguage || 'EN';
                } catch {
                    return 'EN';
                }
            }

            userLang = await getUserLanguage();
            await loadLangFile(userLang);

            // Set all UI texts
            document.getElementById('pageTitle').textContent = `Tontoo AI | ${lang.settings_title}`;
            document.querySelector('h2').textContent = lang.settings_title;
            document.getElementById('personalInfoTitle').textContent = lang.personal_info;
            document.getElementById('firstNameLabel').textContent = lang.first_name;
            document.getElementById('locationLabel').textContent = lang.location;
            document.getElementById('personalPromptLabel').textContent = lang.personal_prompt;
            document.getElementById('panelLanguageLabel').textContent = lang.panel_language;
            document.getElementById('panelLanguage').options[0].text = lang.english;
            document.getElementById('panelLanguage').options[1].text = lang.german;
            document.getElementById('savePersonalBtn').textContent = lang.save;

            document.getElementById('changePasswordTitle').textContent = lang.change_password;
            document.getElementById('currentPasswordLabel').textContent = lang.current_password;
            document.getElementById('newPasswordLabel').textContent = lang.new_password;
            document.getElementById('confirmNewPasswordLabel').textContent = lang.confirm_new_password;
            document.getElementById('savePasswordBtn').textContent = lang.save;

            document.getElementById('changeEmailTitle').textContent = lang.change_email;
            document.getElementById('newEmailLabel').textContent = lang.new_email;
            document.getElementById('emailConfirmPasswordLabel').textContent = lang.confirm_password;
            document.getElementById('saveEmailBtn').textContent = lang.save;

            const popupContainer = document.getElementById('popupContainer');
            function showPopup(message, type = 'error') {
                const popup = document.createElement('div');
                popup.classList.add('popup', type);
                popup.textContent = message;
                popupContainer.appendChild(popup);
                setTimeout(() => {
                    popup.remove();
                }, 3000);
            }

            // Hilfsfunktion für authentifizierte Anfragen
            async function authenticatedFetch(url, options = {}) {
                const token = localStorage.getItem('authToken');
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    ...options.headers
                };
                const response = await fetch(url, { ...options, headers });
                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login.html';
                    throw new Error('Nicht authentifiziert oder nicht autorisiert.');
                }
                return response;
            }

            // Funktion zum Laden der aktuellen Benutzerdaten
            async function loadUserData() {
                try {
                    const response = await authenticatedFetch('/api/user/me');
                    if (!response.ok) throw new Error();
                    const userData = await response.json();
                    document.getElementById('firstName').value = userData.firstName || '';
                    document.getElementById('location').value = userData.profile.location || '';
                    document.getElementById('personalPrompt').value = userData.profile['personal-ai-prompt'] || '';
                    document.getElementById('panelLanguage').value = userData.panelLanguage || 'EN';
                } catch (error) {
                    showPopup(lang.error_load_user, 'error');
                }
            }

            // Formular für persönliche Informationen
            document.getElementById('personalInfoForm').addEventListener('submit', async (event) => {
                event.preventDefault();
                const firstName = document.getElementById('firstName').value;
                const location = document.getElementById('location').value;
                const personalPrompt = document.getElementById('personalPrompt').value;
                const panelLanguage = document.getElementById('panelLanguage').value;

                try {
                    const response = await authenticatedFetch('/api/user/update-profile', {
                        method: 'POST',
                        body: JSON.stringify({ firstName, location, personalPrompt, panelLanguage })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showPopup(lang.success_save_personal, 'success');
                        // Reload language if changed
                        if (panelLanguage !== userLang) {
                            await loadLangFile(panelLanguage);
                            location.reload();
                        }
                    } else {
                        showPopup(data.message || lang.error_save_personal, 'error');
                    }
                } catch (error) {
                    showPopup(lang.error_save_personal, 'error');
                }
            });

            // Formular für Passwortänderung
            document.getElementById('passwordChangeForm').addEventListener('submit', async (event) => {
                event.preventDefault();
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmNewPassword = document.getElementById('confirmNewPassword').value;

                if (newPassword !== confirmNewPassword) {
                    showPopup(lang.passwords_not_match, 'error');
                    return;
                }

                try {
                    const response = await authenticatedFetch('/api/user/change-password', {
                        method: 'POST',
                        body: JSON.stringify({ currentPassword, newPassword })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showPopup(lang.success_save_password, 'success');
                        document.getElementById('passwordChangeForm').reset();
                    } else {
                        showPopup(data.message || lang.error_save_password, 'error');
                    }
                } catch (error) {
                    showPopup(lang.error_save_password, 'error');
                }
            });

            // Formular für E-Mail-Änderung
            document.getElementById('emailChangeForm').addEventListener('submit', async (event) => {
                event.preventDefault();
                const newEmail = document.getElementById('newEmail').value;
                const emailConfirmPassword = document.getElementById('emailConfirmPassword').value;

                try {
                    const response = await authenticatedFetch('/api/user/change-email', {
                        method: 'POST',
                        body: JSON.stringify({ newEmail, password: emailConfirmPassword })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showPopup(lang.success_save_email, 'success');
                        document.getElementById('emailChangeForm').reset();
                    } else {
                        showPopup(data.message || lang.error_save_email, 'error');
                    }
                } catch (error) {
                    showPopup(lang.error_save_email, 'error');
                }
            });

            // Benutzerdaten beim Laden der Seite laden
            loadUserData();
        });
    </script>
</body>
</html>